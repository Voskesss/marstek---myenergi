<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>myenergi ‚Üî Marstek Live Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f7;
            color: #1d1d1f;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            border: 1px solid #e5e5e7;
        }
        .card h3 {
            margin: 0 0 15px 0;
            color: #1d1d1f;
            font-size: 18px;
            font-weight: 600;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .metric:last-child {
            border-bottom: none;
        }
        .metric-label {
            font-weight: 500;
            color: #666;
        }
        .metric-value {
            font-weight: 600;
            font-size: 16px;
        }
        .status-good { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-danger { color: #dc3545; }
        .status-info { color: #007bff; }
        
        .decision-box {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        .decision-box.blocked {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        .decision-box.allowed {
            border-left-color: #28a745;
            background: #f0fff4;
        }
        
        .log-container {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background: #0056b3;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .test-panel {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .auto-refresh {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Battery Selector Popup */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 1000;
        }
        
        .popup-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #e5e5e7;
            padding-bottom: 15px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .battery-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e5e5e7;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .battery-item:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }
        
        .battery-item.connected {
            border-color: #28a745;
            background: #f0fff4;
        }
        
        .battery-item.connecting {
            border-color: #ffc107;
            background: #fffbf0;
        }
        
        .battery-info {
            flex: 1;
        }
        
        .battery-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .battery-details {
            color: #666;
            font-size: 14px;
        }
        
        .battery-actions {
            display: flex;
            gap: 10px;
        }
        
        .scanning {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Battery Status Cards */
        .battery-status-card {
            background: #f8f9fa;
            border: 2px solid #e5e5e7;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
        }
        
        .battery-status-card.connected {
            border-color: #28a745;
            background: #f0fff4;
        }
        
        .battery-status-card.error {
            border-color: #dc3545;
            background: #fff5f5;
        }
        
        .battery-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .battery-ip {
            color: #666;
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .battery-connection, .battery-soc, .battery-power, .battery-mode {
            margin: 3px 0;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîã myenergi ‚Üî Marstek Live Dashboard</h1>
            <p>Real-time monitoring en controle van je energie systeem</p>
        </div>
        
        <div class="auto-refresh">
            <label>
                <input type="checkbox" id="autoRefresh" checked> Auto-refresh (2s)
            </label>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="refreshData()">üîÑ Refresh Nu</button>
            <button class="btn btn-success" onclick="allowBattery()">‚úÖ Batterij Toestaan</button>
            <button class="btn btn-danger" onclick="blockBattery()">üö´ Batterij Blokkeren</button>
            <button class="btn btn-secondary" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
        </div>
        
        <div class="test-panel">
            <h4>üß™ Test Scenarios</h4>
            <div class="controls">
                <button class="btn btn-secondary" onclick="testScenario('low_sun')">‚òÅÔ∏è Weinig Zon (2kW)</button>
                <button class="btn btn-secondary" onclick="testScenario('medium_sun')">üå§Ô∏è Matige Zon (4kW)</button>
                <button class="btn btn-secondary" onclick="testScenario('high_sun')">‚òÄÔ∏è Veel Zon (6kW)</button>
                <button class="btn btn-secondary" onclick="testScenario('zappi_active')">üöó Zappi Actief</button>
            </div>
        </div>
        
        <div class="status-grid">
            <!-- PV Generation -->
            <div class="card">
                <h3>‚òÄÔ∏è PV Generatie</h3>
                <div class="metric">
                    <span class="metric-label">Opwekking</span>
                    <span class="metric-value" id="pvGeneration">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Status</span>
                    <span class="metric-value" id="pvStatus">-</span>
                </div>
            </div>
            
            <!-- Grid Export -->
            <div class="card">
                <h3>‚ö° Grid</h3>
                <div class="metric">
                    <span class="metric-label">Export/Import</span>
                    <span class="metric-value" id="gridExport">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Status</span>
                    <span class="metric-value" id="gridStatus">-</span>
                </div>
            </div>
            
            <!-- House Consumption -->
            <div class="card">
                <h3>üè† Huis Verbruik</h3>
                <div class="metric">
                    <span class="metric-label">Verbruik</span>
                    <span class="metric-value" id="houseConsumption">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Status</span>
                    <span class="metric-value" id="houseStatus">-</span>
                </div>
            </div>
            
            <!-- Eddi Status -->
            <div class="card">
                <h3>üî• Eddi (Warmwater)</h3>
                <div class="metric">
                    <span class="metric-label">Vermogen</span>
                    <span class="metric-value" id="eddiPower">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Tank 1 Temp</span>
                    <span class="metric-value" id="tank1Temp">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Tank 2 Temp</span>
                    <span class="metric-value" id="tank2Temp">-</span>
                </div>
            </div>
            
            <!-- Zappi Status -->
            <div class="card">
                <h3>üöó Zappi (Auto)</h3>
                <div class="metric">
                    <span class="metric-label">Vermogen</span>
                    <span class="metric-value" id="zappiPower">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Status</span>
                    <span class="metric-value" id="zappiStatus">-</span>
                </div>
            </div>
            
            <!-- Batterij Status -->
            <div class="card">
                <h3>üîã Marstek Batterijen</h3>
                <div class="metric">
                    <span class="metric-label">Actieve Batterij</span>
                    <span class="metric-value" id="activeBattery">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">SoC</span>
                    <span class="metric-value" id="batterySoc">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Vermogen</span>
                    <span class="metric-value" id="batteryPower">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Status</span>
                    <span class="metric-value" id="batteryStatus">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Connectie</span>
                    <span class="metric-value" id="batteryConnection">-</span>
                </div>
                <div class="controls" style="margin-top: 10px;">
                    <h4>üîã MQTT Batterij Controle</h4>
                    <div style="display: flex; gap: 10px; margin: 10px 0; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="sendMQTTCommand('marstek', 'command/mode', 'charge')">üîã Laden B1</button>
                        <button class="btn btn-secondary" onclick="sendMQTTCommand('marstek', 'command/mode', 'discharge')">‚ö° Ontladen B1</button>
                        <button class="btn btn-info" onclick="sendMQTTCommand('marstek', 'command/mode', 'auto')">ü§ñ Auto B1</button>
                        <button class="btn btn-warning" onclick="sendMQTTCommand('marstek', 'status/request', 'get_status')">üìä Status B1</button>
                    </div>
                    <div style="display: flex; gap: 10px; margin: 10px 0; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="sendMQTTCommand('marsteka', 'command/mode', 'charge')">üîã Laden B2</button>
                        <button class="btn btn-secondary" onclick="sendMQTTCommand('marsteka', 'command/mode', 'discharge')">‚ö° Ontladen B2</button>
                        <button class="btn btn-info" onclick="sendMQTTCommand('marsteka', 'command/mode', 'auto')">ü§ñ Auto B2</button>
                        <button class="btn btn-warning" onclick="sendMQTTCommand('marsteka', 'status/request', 'get_status')">üìä Status B2</button>
                    </div>
                    <div style="display: flex; gap: 10px; margin: 10px 0; align-items: center;">
                        <input type="number" id="powerInput" placeholder="Power (W)" value="1000" style="width: 100px; padding: 5px;">
                        <button class="btn btn-success" onclick="sendPowerCommand('marstek')">Set Power B1</button>
                        <button class="btn btn-success" onclick="sendPowerCommand('marsteka')">Set Power B2</button>
                    </div>
                    <div id="mqttStatus" style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 14px;">
                        <strong>MQTT:</strong> <span id="mqttConnectionStatus">Niet verbonden</span>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <h4>üîã Batterij Status</h4>
                        <div id="batteryStatusList" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                            <div class="battery-status-card" id="marstek-status">
                                <div class="battery-name">üì± Batterij 1 (marstek)</div>
                                <div class="battery-ip">IP: 192.168.68.78</div>
                                <div class="battery-connection" id="marstek-connection">‚ùå Niet verbonden</div>
                                <div class="battery-soc" id="marstek-soc">SoC: -</div>
                                <div class="battery-power" id="marstek-power">Power: -</div>
                                <div class="battery-mode" id="marstek-mode">Mode: -</div>
                            </div>
                            
                            <div class="battery-status-card" id="marsteka-status">
                                <div class="battery-name">üì± Batterij 2 (marsteka)</div>
                                <div class="battery-ip">IP: 192.168.68.66</div>
                                <div class="battery-connection" id="marsteka-connection">‚ùå Niet verbonden</div>
                                <div class="battery-soc" id="marsteka-soc">SoC: -</div>
                                <div class="battery-power" id="marsteka-power">Power: -</div>
                                <div class="battery-mode" id="marsteka-mode">Mode: -</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Beslissing Logic -->
        <div class="card">
            <h3>üß† Beslissing Logic</h3>
            <div id="decisionBox" class="decision-box">
                <strong>Wachten op data...</strong>
            </div>
            <div class="metric">
                <span class="metric-label">Laatste Schakel</span>
                <span class="metric-value" id="lastSwitch">-</span>
            </div>
            <div class="metric">
                <span class="metric-label">Cooldown OK</span>
                <span class="metric-value" id="cooldownOk">-</span>
            </div>
        </div>
        
        <!-- Batterij Discovery -->
        <div class="card" id="batteryDiscovery" style="display: none;">
            <h3>üîç Gevonden Batterijen</h3>
            <div id="discoveredBatteries">
                <p>Klik op "Zoek Batterijen" om te scannen...</p>
            </div>
        </div>
        
        <!-- Battery Setup Instructions -->
        <div class="card">
            <h3>üîß Batterij Setup Instructies</h3>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4>üì± P1 Meter IP instellen via BLE:</h4>
                <div style="margin-bottom: 15px;">
                    <a href="/ble-legacy" target="_blank" class="btn btn-primary" style="display: inline-block; padding: 8px 16px; background: #2563eb; color: white; text-decoration: none; border-radius: 6px; margin-bottom: 10px;">
                        üîó Open BLE Legacy Tool
                    </a>
                </div>
                <ol style="margin: 10px 0; padding-left: 20px;">
                    <li>Klik de link hierboven om BLE Legacy tool te openen</li>
                    <li>Klik <strong>"Connect to Marstek"</strong> ‚Üí selecteer je batterij</li>
                    <li>Open <strong>browser console</strong> (F12)</li>
                    <li>Kopieer en plak deze code:</li>
                </ol>
                
                <div style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 6px; font-family: monospace; margin: 10px 0;">
                    <div style="color: #68d391; margin-bottom: 8px;">// P1 Meter IP instellen (pas IP aan naar jouw P1 meter)</div>
                    <div style="user-select: all;">const ip = '192.168.68.73';</div>
                    <div style="user-select: all;">await sendCommand(0x21, 'Write Custom Meter IP', [0x0A, ...new TextEncoder().encode(ip)]);</div>
                    <div style="user-select: all;">await sendCommand(0x21, 'Read Meter IP', [0x0B]);</div>
                    <div style="color: #68d391; margin-top: 8px;">// Controleer in de logs of het IP correct is ingesteld</div>
                </div>
                
                <div style="background: #fef5e7; border: 1px solid #f6ad55; padding: 10px; border-radius: 6px; margin-top: 10px;">
                    <strong>‚ö†Ô∏è Let op:</strong> Dit is het IP van je <strong>P1 meter</strong>, niet van de batterij zelf!<br>
                    De batterij gebruikt dit om energie data op te halen van je slimme meter.
                </div>
            </div>
            
            <div style="background: #e6fffa; padding: 15px; border-radius: 8px;">
                <h4>üîç Batterij IP vinden:</h4>
                <p>Als je het IP van de batterij zelf wilt vinden:</p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>Check je router admin panel</li>
                    <li>Zoek naar "MST_ACCP" of "Marstek" devices</li>
                    <li>Of scan netwerk: <code>nmap -sn 192.168.68.0/24</code></li>
                </ul>
            </div>
        </div>

        <!-- Live Logs -->
        <div class="card">
            <h3>üìã Live Logs</h3>
            <div id="logs" class="log-container">
                Logs worden hier getoond...
            </div>
        </div>
    </div>

    <!-- Battery Selector Popup -->
    <div id="batteryPopup" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-header">
                <h2>üîã Batterij Selector</h2>
                <button class="close-btn" onclick="closeBatteryPopup()">&times;</button>
            </div>
            <div id="batteryList">
                <div class="scanning">
                    <div class="spinner"></div>
                    <p>Zoeken naar batterijen...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval;
        let logs = [];
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.unshift(logEntry);
            if (logs.length > 50) logs.pop(); // Keep last 50 logs
            
            const logsElement = document.getElementById('logs');
            logsElement.innerHTML = logs.join('\\n');
            logsElement.scrollTop = 0;
        }
        
        async function refreshData() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                updateDisplay(data);
                addLog('‚úÖ Data refreshed successfully');
            } catch (error) {
                addLog(`‚ùå Error refreshing data: ${error.message}`, 'error');
            }
        }
        
        function updateDisplay(data) {
            // PV Generation
            const pv_w = data.pv_generation_w || 0;
            document.getElementById('pvGeneration').textContent = `${pv_w}W`;
            document.getElementById('pvGeneration').className = `metric-value ${pv_w > 0 ? 'status-good' : 'status-info'}`;
            document.getElementById('pvStatus').textContent = pv_w > 0 ? 'Opwekking' : 'Geen zon';
            
            // Grid Export/Import
            const export_w = data.grid_export_w || 0;
            document.getElementById('gridExport').textContent = `${export_w}W`;
            document.getElementById('gridExport').className = `metric-value ${export_w > 0 ? 'status-good' : 'status-danger'}`;
            document.getElementById('gridStatus').textContent = export_w > 0 ? 'Export' : 'Import';
            
            // House Consumption
            const house_w = data.house_consumption_w || 0;
            document.getElementById('houseConsumption').textContent = `${house_w}W`;
            document.getElementById('houseConsumption').className = `metric-value ${house_w > 0 ? 'status-info' : 'status-good'}`;
            document.getElementById('houseStatus').textContent = house_w > 0 ? 'Verbruikt' : 'Laag verbruik';
            
            // Log myenergi status
            addLog(`‚ö° PV: ${pv_w}W, Huis: ${house_w}W, Export: ${export_w}W, Eddi: ${data.eddi_power_w || 0}W, Zappi: ${data.zappi_power_w || 0}W`);
            
            // Eddi
            const eddi_w = data.eddi_power_w || 0;
            document.getElementById('eddiPower').textContent = `${eddi_w}W`;
            document.getElementById('eddiPower').className = `metric-value ${eddi_w > 200 ? 'status-warning' : 'status-info'}`;
            
            const temps = data.eddi_temperatures || {};
            document.getElementById('tank1Temp').textContent = temps.tank1 ? `${temps.tank1}¬∞C` : 'N/A';
            document.getElementById('tank2Temp').textContent = temps.tank2 ? `${temps.tank2}¬∞C` : 'N/A';
            
            // Zappi
            const zappi_w = data.zappi_power_w || 0;
            document.getElementById('zappiPower').textContent = `${zappi_w}W`;
            document.getElementById('zappiPower').className = `metric-value ${zappi_w > 200 ? 'status-warning' : 'status-info'}`;
            document.getElementById('zappiStatus').textContent = zappi_w > 200 ? 'Actief' : 'Idle';
            
            // Batterij
            const soc = data.marstek_soc || 0;
            const battery_w = data.marstek_power_w || 0;
            const blocked = data.battery_blocked;
            const battery_error = data.marstek_error;
            
            // Show battery data or error
            if (battery_error) {
                document.getElementById('activeBattery').textContent = '‚ùå Niet verbonden';
                document.getElementById('batterySoc').textContent = 'N/A';
                document.getElementById('batteryPower').textContent = 'N/A';
                document.getElementById('batteryStatus').textContent = `‚ùå ${battery_error}`;
                document.getElementById('batteryStatus').className = 'metric-value status-danger';
                document.getElementById('batteryConnection').textContent = data.config?.marstek_use_ble ? 'üîµ BLE (Error)' : 'üåê Network (Error)';
            } else {
                document.getElementById('activeBattery').textContent = 'Verbonden';
                document.getElementById('batterySoc').textContent = `${soc}%`;
                document.getElementById('batteryPower').textContent = `${battery_w}W`;
                document.getElementById('batteryStatus').textContent = blocked ? 'üö´ Geblokkeerd' : '‚úÖ Toegestaan';
                document.getElementById('batteryStatus').className = `metric-value ${blocked ? 'status-danger' : 'status-good'}`;
                document.getElementById('batteryConnection').textContent = data.config?.marstek_use_ble ? 'üîµ BLE' : 'üåê Network';
            }
            
            // Beslissing
            const reason = data.block_reason || 'Geen data';
            const decisionBox = document.getElementById('decisionBox');
            decisionBox.className = `decision-box ${blocked ? 'blocked' : 'allowed'}`;
            decisionBox.innerHTML = `
                <strong>${blocked ? 'üö´ BATTERIJ GEBLOKKEERD' : '‚úÖ BATTERIJ TOEGESTAAN'}</strong><br>
                <em>Reden: ${reason}</em>
            `;
            
            // Timing
            const lastSwitch = data.last_switch ? new Date(data.last_switch * 1000).toLocaleTimeString() : 'Nooit';
            document.getElementById('lastSwitch').textContent = lastSwitch;
            
            const now = Date.now() / 1000;
            const cooldownRemaining = Math.max(0, 60 - (now - (data.last_switch || 0)));
            document.getElementById('cooldownOk').textContent = cooldownRemaining > 0 ? `${Math.ceil(cooldownRemaining)}s` : '‚úÖ OK';
            
            // Log decision
            const statusText = blocked ? 'BLOCKED' : 'ALLOWED';
            addLog(`üîã Battery ${statusText}: ${reason}`);
        }
        
        async function allowBattery() {
            try {
                const response = await fetch('/api/marstek/allow', { method: 'POST' });
                const result = await response.json();
                addLog(`‚úÖ Manual allow: ${result.ok ? 'Success' : 'Failed'}`);
                setTimeout(refreshData, 1000);
            } catch (error) {
                addLog(`‚ùå Error allowing battery: ${error.message}`, 'error');
            }
        }
        
        async function blockBattery() {
            try {
                const response = await fetch('/api/marstek/inhibit', { method: 'POST' });
                const result = await response.json();
                addLog(`üö´ Manual block: ${result.ok ? 'Success' : 'Failed'}`);
                setTimeout(refreshData, 1000);
            } catch (error) {
                addLog(`‚ùå Error blocking battery: ${error.message}`, 'error');
            }
        }
        
        function testScenario(scenario) {
            addLog(`üß™ Testing scenario: ${scenario}`);
            // This would simulate different export values for testing
            // Implementation depends on your test requirements
        }
        
        function clearLogs() {
            logs = [];
            document.getElementById('logs').innerHTML = 'Logs cleared...';
        }
        
        // Battery Popup Functions
        async function discoverBatteries() {
            addLog('üîç Starting battery discovery...');
            
            let allBatteries = { ble: [], network: [], total: 0 };
            
            try {
                // 1. Try Browser BLE API first (clean approach)
                if (navigator.bluetooth) {
                    addLog('üîµ Opening browser BLE selector...');
                    try {
                        const device = await navigator.bluetooth.requestDevice({
                            filters: [
                                { namePrefix: 'MST_ACCP' },
                                { namePrefix: 'MST-ACCP' },
                                { namePrefix: 'MST_SMR' }
                            ],
                            optionalServices: ['battery_service', 'device_information']
                        });
                        
                        if (device) {
                            allBatteries.ble.push({
                                type: 'BLE',
                                name: device.name,
                                address: device.id,
                                battery_type: device.name.includes('ACCP') ? 'ACCP' : 'SMR',
                                rssi: null,
                                browser_device: true
                            });
                            addLog(`‚úÖ Browser BLE selected: ${device.name}`);
                        }
                    } catch (bleError) {
                        if (bleError.name === 'NotFoundError') {
                            addLog('‚ÑπÔ∏è No BLE device selected');
                        } else {
                            addLog(`‚ö†Ô∏è Browser BLE error: ${bleError.message}`);
                        }
                    }
                } else {
                    addLog('‚ö†Ô∏è Browser BLE not supported');
                }
                
                // 2. Always check for network batteries
                addLog('üîç Scanning for network batteries...');
                try {
                    const response = await fetch('/api/batteries/discover', {
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const backendBatteries = await response.json();
                        
                        // Only add network batteries (skip backend BLE to avoid duplicates)
                        if (backendBatteries.network) {
                            allBatteries.network = backendBatteries.network;
                        }
                        
                        addLog(`‚úÖ Network scan found: ${backendBatteries.network?.length || 0} batteries`);
                    }
                } catch (networkError) {
                    addLog(`‚ö†Ô∏è Network scan failed: ${networkError.message}`);
                }
                
                // Calculate total
                allBatteries.total = allBatteries.ble.length + allBatteries.network.length;
                
                // Show popup with results
                document.getElementById('batteryPopup').style.display = 'block';
                displayBatteriesInPopup(allBatteries);
                addLog(`‚úÖ Total found: ${allBatteries.total} batteries`);
                
            } catch (error) {
                addLog(`‚ùå Battery discovery failed: ${error.message}`, 'error');
                console.error('Battery discovery error:', error);
                
                // Show popup with error
                document.getElementById('batteryPopup').style.display = 'block';
                displayBatteriesInPopup({ ble: [], network: [], total: 0, error: error.message });
            }
        }
        
        function displayBatteriesInPopup(batteries) {
            const container = document.getElementById('batteryList');
            let html = '';
            
            if (batteries.error) {
                html = `
                    <div class="scanning">
                        <p>‚ùå Error: ${batteries.error}</p>
                        <button class="btn btn-secondary" onclick="discoverBatteries()">üîÑ Probeer Opnieuw</button>
                    </div>
                `;
            } else if (batteries.total === 0) {
                html = `
                    <div class="scanning">
                        <p>‚ùå Geen batterijen gevonden</p>
                        <p style="font-size: 14px; color: #666;">
                            ‚Ä¢ Check of batterijen aan staan<br>
                            ‚Ä¢ Controleer Bluetooth verbinding<br>
                            ‚Ä¢ Probeer andere netwerk ranges
                        </p>
                        <button class="btn btn-secondary" onclick="discoverBatteries()">üîÑ Opnieuw Scannen</button>
                    </div>
                `;
            } else {
                // Show found batteries
                if (batteries.ble && batteries.ble.length > 0) {
                    html += '<h3>üîµ BLE Batterijen</h3>';
                    batteries.ble.forEach((battery, index) => {
                        const isBrowserDevice = battery.browser_device || false;
                        const connectType = isBrowserDevice ? 'browser_ble' : 'ble';
                        
                        html += `
                            <div class="battery-item" id="battery-ble-${index}">
                                <div class="battery-info">
                                    <div class="battery-name">üì± ${battery.name} ${isBrowserDevice ? '(Browser)' : '(Python)'}</div>
                                    <div class="battery-details">
                                        Type: ${battery.battery_type} | Address: ${battery.address}
                                        ${battery.rssi ? ` | Signal: ${battery.rssi} dBm` : ''}
                                        ${isBrowserDevice ? ' | Via Browser BLE API' : ' | Via Python BLE'}
                                    </div>
                                </div>
                                <div class="battery-actions">
                                    <button class="btn btn-primary" onclick="connectToBatteryFromPopup('${connectType}', '${battery.address}', '${battery.name}', ${index})">
                                        üîó Verbind
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                }
                
                if (batteries.network && batteries.network.length > 0) {
                    html += '<h3>üåê Network Batterijen</h3>';
                    batteries.network.forEach((battery, index) => {
                        html += `
                            <div class="battery-item" id="battery-network-${index}">
                                <div class="battery-info">
                                    <div class="battery-name">üåê ${battery.ip}:${battery.port}</div>
                                    <div class="battery-details">
                                        Network Battery | ${battery.info ? 'Reachable' : 'Basic connection'}
                                    </div>
                                </div>
                                <div class="battery-actions">
                                    <button class="btn btn-primary" onclick="connectToBatteryFromPopup('network', '${battery.ip}:${battery.port}', 'Network-${battery.ip}', ${index})">
                                        üîó Verbind
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += `
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-secondary" onclick="discoverBatteries()">üîÑ Opnieuw Scannen</button>
                        <button class="btn btn-secondary" onclick="closeBatteryPopup()">Sluiten</button>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function closeBatteryPopup() {
            document.getElementById('batteryPopup').style.display = 'none';
        }
        
        // Close popup when clicking outside
        document.getElementById('batteryPopup').addEventListener('click', function(e) {
            if (e.target === this) {
                closeBatteryPopup();
            }
        });
        
        async function connectToBatteryFromPopup(type, address, name, index) {
            addLog(`üîó Connecting to ${name} (${type})...`);
            
            // Update UI to show connecting state
            const batteryItem = document.getElementById(`battery-${type}-${index}`);
            if (batteryItem) {
                batteryItem.classList.add('connecting');
                const button = batteryItem.querySelector('button');
                button.textContent = '‚è≥ Verbinden...';
                button.disabled = true;
            }
            
            try {
                const response = await fetch('/api/batteries/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, address, name })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog(`‚úÖ Connected to ${name}`);
                    
                    // Update UI to show connected state
                    if (batteryItem) {
                        batteryItem.classList.remove('connecting');
                        batteryItem.classList.add('connected');
                        const button = batteryItem.querySelector('button');
                        button.textContent = '‚úÖ Verbonden';
                        button.disabled = false;
                    }
                    
                    // Update main dashboard
                    document.getElementById('activeBattery').textContent = name;
                    
                    // Close popup after successful connection
                    setTimeout(() => {
                        closeBatteryPopup();
                        refreshData();
                    }, 1500);
                    
                } else {
                    addLog(`‚ùå Connection failed: ${result.error}`);
                    
                    // Reset button state
                    if (batteryItem) {
                        batteryItem.classList.remove('connecting');
                        const button = batteryItem.querySelector('button');
                        button.textContent = 'üîó Verbind';
                        button.disabled = false;
                    }
                }
            } catch (error) {
                addLog(`‚ùå Connection error: ${error.message}`, 'error');
                
                // Reset button state
                if (batteryItem) {
                    batteryItem.classList.remove('connecting');
                    const button = batteryItem.querySelector('button');
                    button.textContent = 'üîó Verbind';
                    button.disabled = false;
                }
            }
        }
        
        // Legacy function for backward compatibility
        async function connectToBattery(type, address, name) {
            return connectToBatteryFromPopup(type, address, name, 0);
        }
        
        function switchBattery() {
            addLog('üîÑ Switching to next available battery...');
            // This would cycle through discovered batteries
            discoverBatteries();
        }
        
        // MQTT Functions
        async function sendMQTTCommand(battery, topic, command) {
            addLog(`üì° MQTT: Sending ${battery}/${topic} = ${command}`);
            
            try {
                const response = await fetch('/api/mqtt/publish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: `${battery}/${topic}`,
                        message: command
                    })
                });
                
                if (response.ok) {
                    addLog(`‚úÖ MQTT command sent: ${battery}/${topic}`);
                    document.getElementById('mqttConnectionStatus').textContent = 'Verbonden';
                    document.getElementById('mqttConnectionStatus').style.color = 'green';
                } else {
                    addLog(`‚ùå MQTT command failed: ${response.status}`, 'error');
                    document.getElementById('mqttConnectionStatus').textContent = 'Error';
                    document.getElementById('mqttConnectionStatus').style.color = 'red';
                }
            } catch (error) {
                addLog(`‚ùå MQTT error: ${error.message}`, 'error');
                document.getElementById('mqttConnectionStatus').textContent = 'Disconnected';
                document.getElementById('mqttConnectionStatus').style.color = 'red';
            }
        }
        
        function sendPowerCommand(battery) {
            const power = document.getElementById('powerInput').value;
            if (power) {
                sendMQTTCommand(battery, 'command/power', power);
            } else {
                addLog('‚ùå Voer een power waarde in', 'error');
            }
        }
        
        // Battery Status Functions
        function updateBatteryStatus(battery, status) {
            const card = document.getElementById(`${battery}-status`);
            const connectionEl = document.getElementById(`${battery}-connection`);
            const socEl = document.getElementById(`${battery}-soc`);
            const powerEl = document.getElementById(`${battery}-power`);
            const modeEl = document.getElementById(`${battery}-mode`);
            
            if (status && status.success) {
                card.classList.remove('error');
                card.classList.add('connected');
                connectionEl.textContent = '‚úÖ Verbonden';
                connectionEl.style.color = 'green';
                
                // Update status fields if available
                if (status.soc !== undefined) {
                    socEl.textContent = `SoC: ${status.soc}%`;
                }
                if (status.power !== undefined) {
                    powerEl.textContent = `Power: ${status.power}W`;
                }
                if (status.mode !== undefined) {
                    modeEl.textContent = `Mode: ${status.mode}`;
                }
            } else {
                card.classList.remove('connected');
                card.classList.add('error');
                connectionEl.textContent = '‚ùå Niet verbonden';
                connectionEl.style.color = 'red';
            }
        }
        
        // Auto-request battery status every 10 seconds
        function startBatteryStatusUpdates() {
            setInterval(() => {
                sendMQTTCommand('marstek', 'status/request', 'get_status');
                sendMQTTCommand('marsteka', 'status/request', 'get_status');
            }, 10000);
        }
        
        // Start status updates when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(startBatteryStatusUpdates, 2000); // Start after 2 seconds
        });
        
        // Auto-refresh setup
        document.getElementById('autoRefresh').addEventListener('change', function(e) {
            if (e.target.checked) {
                autoRefreshInterval = setInterval(refreshData, 2000);
                addLog('üîÑ Auto-refresh enabled (2s)');
            } else {
                clearInterval(autoRefreshInterval);
                addLog('‚è∏Ô∏è Auto-refresh disabled');
            }
        });
        
        // Initial load
        refreshData();
        autoRefreshInterval = setInterval(refreshData, 2000);
        addLog('üöÄ Dashboard started');
    </script>
</body>
</html>
