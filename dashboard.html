<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>myenergi ‚Üî Marstek Live Dashboard</title>
    <link rel="icon" href="data:,">
    <style>
        :root {
            --bg-color: #0f172a; /* slate-900 */
            --card-bg: #1e293b; /* slate-800 */
            --border-color: #334155; /* slate-700 */
            --text-primary: #f1f5f9; /* slate-100 */
            --text-secondary: #94a3b8; /* slate-400 */
            --text-tertiary: #64748b; /* slate-500 */
            --accent-blue: #3b82f6;
            --status-green: #22c55e;
            --status-yellow: #f59e0b;
            --status-red: #ef4444;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--bg-color);
            color: var(--text-primary);
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { display:flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { color: var(--text-primary); margin:0; }
        .header p { color: var(--text-secondary); margin:4px 0 0 0; }
        .badge { padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700; border:1px solid var(--border-color); }
        .badge.ok { color: var(--bg-color); background: var(--status-green); border-color: var(--status-green); }
        .badge.degraded { color: #fff; background: var(--status-red); border-color: var(--status-red); }
        .modal { position:fixed; inset:0; background: rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:1000; }
        .modal.open { display:flex; }
        .modal-card { width: min(900px, 94vw); max-height: 80vh; overflow:auto; background: var(--card-bg); border:1px solid var(--border-color); border-radius:12px; padding:16px; }
        .modal-header { display:flex; justify-content: space-between; align-items:center; margin-bottom:10px; }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); }
        .card h3 { margin: 0 0 15px 0; color: var(--text-primary); font-size: 18px; font-weight: 600; }
        .metric { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .metric:last-child { border-bottom: none; }
        .metric-label { font-weight: 500; color: var(--text-secondary); }
        .metric-value { font-weight: 600; font-size: 18px; }
        .status-good { color: var(--status-green); }
        .status-warning { color: var(--status-yellow); }
        .status-danger { color: var(--status-red); }
        .status-info { color: var(--accent-blue); }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-success { background: var(--status-green); color: white; }
        .btn-danger { background: var(--status-red); color: white; }
        .btn-warning { background: var(--status-yellow); color: #1e293b; }
        .btn-secondary { background: var(--border-color); color: var(--text-primary); }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .auto-refresh { text-align: center; margin-bottom: 20px; padding: 10px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color); }
        .battery-card { border: 2px solid var(--border-color); transition: border-color 0.3s; }
        .battery-card.connected { border-color: var(--status-green); }
        .battery-card.error { border-color: var(--status-red); }
        .battery-card.connecting { border-color: var(--status-yellow); }
        .battery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .battery-status-badge { padding: 4px 10px; border-radius: 99px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
        .battery-status-badge.connected { background: var(--status-green); color: var(--bg-color); }
        .battery-status-badge.error { background: var(--status-red); color: white; }
        .battery-status-badge.connecting { background: var(--status-yellow); color: var(--bg-color); }
        .modbus-info { font-size: 12px; color: var(--text-tertiary); margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        input[type=range] { -webkit-appearance: none; appearance: none; width: 100%; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { background: var(--border-color); height: 4px; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: var(--accent-blue); cursor: pointer; margin-top: -7px; }
        pre { white-space:pre-wrap; word-break:break-word; background:#0b1220; padding:12px; border-radius:8px; border:1px solid #1f2937; color: var(--text-secondary); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üîã myenergi ‚Üî Marstek Live Dashboard</h1>
                <p>Real-time monitoring en controle van je energie systeem</p>
            </div>
            <div>
                <span id="backendHealthBadge" class="badge degraded">Backend: onbekend</span>
            </div>
        </div>
        
        <div class="auto-refresh">
            <label>
                <input type="checkbox" id="autoRefresh" checked> Auto-refresh (5s)
            </label>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="refreshData()">üîÑ Refresh Nu</button>
            <button class="btn btn-warning" onclick="restartApplication()">üîÑ Restart App</button>
            <button class="btn btn-secondary" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
            <button id="btnLogs" class="btn">üìÑ Bekijk logs</button>
            <button id="btnFlow" class="btn" onclick="window.open('/flow.html','_blank')">üåê Visual Flow</button>
        </div>
        
        <!-- Logs Modal -->
        <div id="logsModal" class="modal" onclick="if(event.target===this) closeLogsModal()">
            <div class="modal-card">
                <div class="modal-header">
                    <h3>Server logs</h3>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <label style="font-size:12px; color:var(--text-secondary); display:flex; align-items:center; gap:6px;">
                            <input id="logsImportantOnly" type="checkbox" checked>
                            Alleen belangrijke
                        </label>
                        <button class="btn btn-secondary" onclick="closeLogsModal()">Sluit</button>
                    </div>
                </div>
                <div id="logsContainer"><pre id="logsContent">Laden...</pre></div>
            </div>
        </div>
        
        <div class="status-grid" style="margin-bottom: 20px;">
            <div class="card">
                <h3>‚òÄÔ∏è PV Generatie</h3>
                <div class="metric"><span class="metric-label">Opwekking</span><span class="metric-value" id="pvGeneration">-</span></div>
                <div class="metric"><span class="metric-label">Status</span><span class="metric-value" id="pvStatus">-</span></div>
            </div>
            <div class="card">
                <h3>‚ö° Grid</h3>
                <div class="metric"><span class="metric-label">Import/Export</span><span class="metric-value" id="gridExport">-</span></div>
                <div class="metric"><span class="metric-label">Status</span><span class="metric-value" id="gridStatus">-</span></div>
            </div>
            <div class="card">
                <h3>üè† Huis Verbruik</h3>
                <div class="metric"><span class="metric-label">Verbruik</span><span class="metric-value" id="houseConsumption">-</span></div>
                <div class="metric"><span class="metric-label">Status</span><span class="metric-value" id="houseStatus">-</span></div>
            </div>
            <div class="card">
                <h3>üî• Eddi (Warmwater)</h3>
                <div class="metric"><span class="metric-label">Vermogen</span><span class="metric-value" id="eddiPower">-</span></div>
                <div class="metric"><span class="metric-label">Tank 1 Temp</span><span class="metric-value" id="tank1Temp">-</span></div>
                <div class="metric"><span class="metric-label">Tank 2 Temp</span><span class="metric-value" id="tank2Temp">-</span></div>
            </div>
            <div class="card">
                <h3>üöó Zappi (Auto)</h3>
                <div class="metric"><span class="metric-label">Vermogen</span><span class="metric-value" id="zappiPower">-</span></div>
            </div>

            <!-- Legacy cards kept but hidden by startAutoRefresh; leave them here for safety/testing -->
            <!-- Column 2: Battery 1 -->
            <div class="card battery-card connecting" id="battery78-card">
                <div class="battery-header">
                    <h3>üîã Venus E Batterij 78</h3>
                    <span class="battery-status-badge connecting" id="battery78-badge">Connecting</span>
                </div>
                <div class="metric"><span class="metric-label">State of Charge</span><span class="metric-value status-info" id="battery78-soc">--</span></div>
                <div class="metric"><span class="metric-label">Energy Remaining</span><span class="metric-value" id="battery78-energy">--</span></div>
                <div class="metric"><span class="metric-label">Battery Power</span><span class="metric-value" id="battery78-power">--</span></div>
                <div class="metric"><span class="metric-label">Huidige Actie</span><span class="metric-value" id="battery78-action">--</span></div>
                <div class="metric"><span class="metric-label">RS485 Control</span><span class="metric-value" id="battery78-rs485">--</span></div>
                <div class="metric"><span class="metric-label">Mode Cmd</span><span class="metric-value" id="battery78-cmd">--</span></div>
                <div class="metric"><span class="metric-label">Setpoint Charge</span><span class="metric-value" id="battery78-sp-charge">--</span></div>
                <div class="metric"><span class="metric-label">Setpoint Discharge</span><span class="metric-value" id="battery78-sp-discharge">--</span></div>

                <!-- CONTROLS -->
                <div class="metric" style="flex-direction: column; align-items: flex-start; gap:12px; padding-top:15px; border-top: 1px solid var(--border-color); margin-top: 15px;">
                    <span class="metric-label" style="margin-bottom: 8px;">Handmatige Controle</span>
                    <div style="width:100%;">
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom: 10px;">
                            <label style="color:var(--text-secondary);">Power</label>
                            <input id="powerSlider" type="range" min="0" max="2000" step="50" value="500" oninput="document.getElementById('powerValue').textContent=this.value+' W'" />
                            <span id="powerValue" style="min-width:60px; text-align:right; font-weight:600;">500 W</span>
                        </div>
                        <div style="display:flex; flex-wrap:wrap; gap:8px;">
                            <button class="btn btn-success" onclick="batteryControlFor('venus_ev2_92','charge')">Force Charge</button>
                            <button class="btn btn-danger" onclick="batteryControlFor('venus_ev2_92','discharge')">Force Discharge</button>
                            <button class="btn btn-secondary" onclick="batteryControlFor('venus_ev2_92','stop')">Stop Force</button>
                        </div>
                    </div>
                    <div style="width:100%; border-top: 1px solid var(--border-color); margin-top: 15px; padding-top: 15px;">
                         <label style="color:var(--text-secondary); margin-bottom: 5px;">Hoofd Werkmodus</label>
                         <div style="margin-bottom: 10px; font-size: 14px; color: var(--text-primary);">
                            Huidig: <span id="current-work-mode" style="font-weight: bold; color: var(--success-color);">-</span>
                         </div>
                        <div style="display:flex; flex-wrap:wrap; gap:8px;">
                            <button id="work-mode-0" class="btn btn-primary" onclick="setWorkModeFor('venus_ev2_92',0)">Manual</button>
                            <button id="work-mode-1" class="btn btn-primary" onclick="setWorkModeFor('venus_ev2_92',1)">Anti-Feed</button>
                            <button id="work-mode-2" class="btn btn-primary" onclick="setWorkModeFor('venus_ev2_92',2)">Trade</button>
                        </div>
                    </div>
                    <div style="width:100%; border-top: 1px solid var(--border-color); margin-top: 15px; padding-top: 15px;">
                         <label style="color:var(--text-secondary); margin-bottom: 5px;">Minimum SoC Bescherming</label>
                         <div style="margin-bottom: 10px; font-size: 14px; color: var(--text-primary);">
                            Huidig SoC: <span id="current-soc-display" style="font-weight: bold; color: var(--success-color);">-</span> |
                            Actieve Min: <span id="active-min-soc" style="font-weight: bold; color: var(--warning-color);">-</span>
                         </div>
                         <div style="margin-bottom: 10px; font-size: 14px; color: var(--text-primary);">
                            Status: <span id="soc-protection-status" style="font-weight: bold;">-</span>
                         </div>
                         <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                            <label style="min-width:80px; font-size:14px;">Min SoC:</label>
                            <input id="minSocSlider" type="range" min="15" max="100" step="1" value="20" 
                                   oninput="document.getElementById('minSocValue').textContent=this.value+'%'" 
                                   style="flex:1;" />
                            <span id="minSocValue" style="min-width:50px; text-align:right; font-weight:600;">20%</span>
                         </div>
                         <div style="display:flex; flex-wrap:wrap; gap:8px;">
                            <button class="btn btn-primary" onclick="setMinimumSoc()">Instellen</button>
                            <button class="btn btn-warning" onclick="resetToFactory()">Reset naar Fabrikant</button>
                         </div>
                    </div>
                </div>
                <div class="modbus-info">
                    <span id="battery78-control-msg" style="font-size: 12px;"></span><br>
                    <strong>Last Update:</strong> <span id="battery78-timestamp">--</span>
                </div>
            </div>

            <!-- Column 3: Battery 2 (WiFi Converter) -->
            <div class="card battery-card connecting" id="battery2-card">
                <div class="battery-header">
                    <h3>üîã Batterij 2 (WiFi Converter)</h3>
                    <span class="battery-status-badge connecting" id="battery2-badge">Connecting</span>
                </div>
                <div class="metric"><span class="metric-label">State of Charge</span><span class="metric-value status-info" id="battery2-soc">--</span></div>
                <div class="metric"><span class="metric-label">Energy Remaining</span><span class="metric-value" id="battery2-energy">--</span></div>
                <div class="metric"><span class="metric-label">Battery Power</span><span class="metric-value" id="battery2-power">--</span></div>
                <div class="metric"><span class="metric-label">Huidige Actie</span><span class="metric-value" id="battery2-action">--</span></div>
                <div class="metric"><span class="metric-label">IP</span><span class="metric-value" id="battery2-ip">--</span></div>
                <div class="metric"><span class="metric-label">Port</span><span class="metric-value" id="battery2-port">--</span></div>
                <!-- CONTROLS (Battery 2) -->
                <div class="metric" style="flex-direction: column; align-items: flex-start; gap:12px; padding-top:15px; border-top: 1px solid var(--border-color); margin-top: 15px;">
                    <span class="metric-label" style="margin-bottom: 8px;">Handmatige Controle</span>
                    <div style="width:100%;">
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom: 10px;">
                            <label style="color:var(--text-secondary);">Power</label>
                            <input id="powerSlider2" type="range" min="0" max="2000" step="50" value="500" oninput="document.getElementById('powerValue2').textContent=this.value+' W'" />
                            <span id="powerValue2" style="min-width:60px; text-align:right; font-weight:600;">500 W</span>
                        </div>
                        <div style="display:flex; flex-wrap:wrap; gap:8px;">
                            <button id="b2-charge" class="btn btn-success" onclick="batteryControlFor('venus_ev2_74','charge')">Force Charge</button>
                            <button id="b2-discharge" class="btn btn-danger" onclick="batteryControlFor('venus_ev2_74','discharge')">Force Discharge</button>
                            <button id="b2-stop" class="btn btn-secondary" onclick="batteryControlFor('venus_ev2_74','stop')">Stop Force</button>
                        </div>
                    </div>
                    <div style="width:100%; border-top: 1px solid var(--border-color); margin-top: 15px; padding-top: 15px;">
                        <label style="color:var(--text-secondary); margin-bottom: 5px;">Hoofd Werkmodus</label>
                        <div style="display:flex; flex-wrap:wrap; gap:8px;">
                            <button id="work-mode2-0" class="btn btn-primary" onclick="setWorkModeFor('venus_ev2_74',0)">Manual</button>
                            <button id="work-mode2-1" class="btn btn-primary" onclick="setWorkModeFor('venus_ev2_74',1)">Anti-Feed</button>
                            <button id="work-mode2-2" class="btn btn-primary" onclick="setWorkModeFor('venus_ev2_74',2)">Trade</button>
                        </div>
                    </div>
                </div>
                <div class="modbus-info">
                    <span id="battery2-control-msg" style="font-size: 12px;"></span><br>
                    <strong>Last Update:</strong> <span id="battery2-timestamp">--</span>
                </div>
            </div>
        </div>
        
        <!-- Simple Battery Rule (export-driven) -->
        <div class="card" id="simple-rule-card" style="margin-bottom: 20px;">
            <h3>‚ö° Simple Battery Rule (export)</h3>
            <div style="display:flex; align-items:center; gap:10px; margin-bottom: 12px;">
                <button id="simple-rule-toggle" class="btn btn-primary" onclick="toggleSimpleRule()">AAN</button>
                <span id="simple-rule-state" class="status-info">Uit</span>
            </div>
            <div class="metric"><span class="metric-label">Grid</span><span class="metric-value" id="sr-grid">--</span></div>
            <div class="metric"><span class="metric-label">Overschot (EMA)</span><span class="metric-value" id="sr-overschot">--</span></div>
            <div class="metric"><span class="metric-label">Doel Export</span><span class="metric-value" id="sr-target-export">--</span></div>
            <div class="metric"><span class="metric-label">Batterij Target Totaal</span><span class="metric-value" id="sr-target-total">--</span></div>
            <div class="metric"><span class="metric-label">Batterij Set Totaal</span><span class="metric-value" id="sr-set-total">--</span></div>
            <div class="metric"><span class="metric-label">Cooldown</span><span class="metric-value" id="sr-cooldown">--</span></div>
            <div class="metric"><span class="metric-label">Per Batterij</span><span class="metric-value" id="sr-per-batt" style="font-size:14px;">--</span></div>
        </div>
        
    </div>

    <script>
        let autoRefreshInterval;
        // Anti-flicker cache with zero-confirmation
        const __stable = {
            cache: {},
            streak: {},
            // Basic stabilizer (kept for compatibility)
            num(key, newVal, {ttlMs=6000, treatZeroAsInvalid=true}={}){
                const now = Date.now();
                const prev = this.cache[key];
                const isNullish = (newVal === null || newVal === undefined || Number.isNaN(newVal));
                const isZero = Number(newVal) === 0;
                const zeroIsGlitch = treatZeroAsInvalid && isZero && prev && prev.val !== 0 && (now - prev.ts) < ttlMs;
                const valid = !isNullish && !(zeroIsGlitch);
                if (valid){ this.cache[key] = {val: Number(newVal), ts: now}; return Number(newVal); }
                if (prev && (now - prev.ts) < ttlMs){ return prev.val; }
                if (!isNullish) return Number(newVal);
                return prev ? prev.val : 0;
            },
            // Zero-aware stabilizer: require N consecutive zeros or TTL expiry to accept zero
            numZeroAware(key, newVal, {ttlMs=6000, confirmZeros=2}={}){
                const now = Date.now();
                const prev = this.cache[key];
                const isNullish = (newVal === null || newVal === undefined || Number.isNaN(newVal));
                const v = Number(newVal || 0);
                if (!isNullish && v !== 0){
                    this.cache[key] = {val: v, ts: now};
                    this.streak[key] = 0;
                    return v;
                }
                if (!isNullish && v === 0){
                    const s = (this.streak[key] || 0) + 1;
                    this.streak[key] = s;
                    if (s >= confirmZeros) {
                        this.cache[key] = {val: 0, ts: now};
                        return 0;
                    }
                }
                if (prev && (now - prev.ts) < ttlMs){ return prev.val; }
                // If no prev or expired, return current (0 or 0-ish)
                return v;
            }
        };

        // --- API Wrappers ---
        async function setWorkMode(mode) {
            const el = document.getElementById('battery78-control-msg');
            const workModeButtons = document.querySelectorAll('[id^="work-mode-"]');
            
            try {
                // Disable work mode buttons and show loading
                workModeButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.6';
                });
                el.textContent = `‚è≥ Werkmodus wordt ingesteld...`;
                el.className = 'status-info';
                
                const res = await fetch('/api/battery/set_work_mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode })
                });
                const j = await res.json();
                if (j.success) {
                    const modeMap = {0: 'Manual', 1: 'Anti-Feed', 2: 'Trade Mode'};
                    el.textContent = `‚úÖ Werkmodus: ${modeMap[mode]}`;
                    el.className = 'status-good';
                } else {
                    el.textContent = `‚ùå Fout: ${j.error || 'onbekend'}`;
                    el.className = 'status-danger';
                }
                setTimeout(refreshData, 1200);
            } catch (e) {
                el.textContent = `‚ùå Fout bij werkmodus: ${e}`;
                el.className = 'status-danger';
            } finally {
                // Re-enable work mode buttons after 2 seconds
                setTimeout(() => {
                    workModeButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    });
                }, 2000);
            }
        }

        function updateBattery2(batteryData) {
            const prefix = 'battery2';
            if (batteryData && batteryData.success && batteryData.data) {
                setBatteryStatus(prefix, 'connected');
                const d = batteryData.derived || {};
                const raw = batteryData.data || {};

                // SoC
                const socEl = document.getElementById(`${prefix}-soc`);
                if (socEl) {
                    const soc = d.soc_percent;
                    socEl.textContent = soc != null ? `${soc.toFixed(1)} %` : '--';
                    socEl.className = soc > 80 ? 'metric-value status-good' : soc > 20 ? 'metric-value status-warning' : 'metric-value status-danger';
                }

                // Energy Remaining
                const energyEl = document.getElementById(`${prefix}-energy`);
                if (energyEl && d.remaining_kwh != null) energyEl.textContent = `${d.remaining_kwh.toFixed(2)} kWh`;

                // Power
                const powerEl = document.getElementById(`${prefix}-power`);
                if (powerEl) {
                    const pw = d.power_w;
                    if (pw != null) {
                        powerEl.textContent = `${pw.toFixed(0)} W`;
                        powerEl.className = pw > 20 ? 'metric-value status-good' : pw < -20 ? 'metric-value status-danger' : 'metric-value';
                    } else {
                        powerEl.textContent = '--';
                    }
                }

                // Mode/Action
                const actionEl = document.getElementById(`${prefix}-action`);
                if (actionEl) {
                    const modeText = (raw.work_mode && (raw.work_mode.formatted || raw.work_mode.value)) || (d.mode || 'Onbekend');
                    actionEl.textContent = String(modeText);
                    if (modeText === 'Charging') actionEl.className = 'metric-value status-good';
                    else if (modeText === 'Discharging') actionEl.className = 'metric-value status-danger';
                    else actionEl.className = 'metric-value';
                }

                // Timestamp
                const tsEl = document.getElementById(`${prefix}-timestamp`);
                if (tsEl) tsEl.textContent = new Date().toLocaleTimeString();
            } else {
                setBatteryStatus(prefix, 'error');
            }
        }

        async function batteryControlFor(bid, action) {
            const el = bid === 'venus_ev2_92' ? document.getElementById('battery78-control-msg') : document.getElementById('battery2-control-msg');
            const cardId = bid === 'venus_ev2_92' ? 'battery78-card' : 'battery2-card';
            const card = document.getElementById(cardId);
            const buttons = card ? card.querySelectorAll('.btn') : document.querySelectorAll('.btn');
            try {
                buttons.forEach(btn => { btn.disabled = true; btn.style.opacity = '0.6'; });
                if (el) { el.textContent = `‚è≥ ${action} wordt uitgevoerd...`; el.className = 'status-info'; }
                const sliderId = bid === 'venus_ev2_92' ? 'powerSlider' : 'powerSlider2';
                const powerEl = document.getElementById(sliderId);
                const power_w = powerEl ? parseInt(powerEl.value, 10) : undefined;
                const payload = power_w != null ? { action, power_w } : { action };
                const res = await fetch(`/api/batteries/${bid}/control`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                const j = await res.json();
                if (el) {
                    if (j.success) { el.textContent = `‚úÖ ${action} ok`; el.className = 'status-good'; }
                    else { el.textContent = `‚ùå Fout: ${j.error || 'onbekend'}`; el.className = 'status-danger'; }
                }
                setTimeout(refreshData, 1200);
            } catch (e) {
                if (el) { el.textContent = `‚ùå Fout bij ${action}: ${e}`; el.className = 'status-danger'; }
            } finally {
                setTimeout(() => { buttons.forEach(btn => { btn.disabled = false; btn.style.opacity = '1'; }); }, 2000);
            }
        }

        // Energy Rules Management
        async function updateRule(ruleType) {
            try {
                const rules = {
                    boiler_priority: {
                        enabled: false
                    }
                };

                const res = await fetch('/api/energy_rules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(rules)
                });
                
                const result = await res.json();
                if (result.success) {
                    // Removed currentRule element
                    // Removed currentRule element
                } else {
                    console.error('Failed to update rules:', result.error);
                }
            } catch (e) {
                console.error('Error updating rules:', e);
            }
        }

        function updateWorkModeButtons(currentMode) {
            const modeMap = {0: 'Manual', 1: 'Anti-Feed', 2: 'Trade Mode'};
            
            // Update current mode display
            const currentModeEl = document.getElementById('current-work-mode');
            if (currentModeEl && currentMode !== null && currentMode !== undefined) {
                currentModeEl.textContent = modeMap[currentMode] || `Mode ${currentMode}`;
            }
            
            // Update button styles
            for (let i = 0; i <= 2; i++) {
                const btn = document.getElementById(`work-mode-${i}`);
                if (btn) {
                    if (i === currentMode) {
                        // Active button: green, pressed, disabled
                        btn.className = 'btn btn-success';
                        btn.style.opacity = '0.8';
                        btn.style.transform = 'scale(0.95)';
                        btn.disabled = true;
                    } else {
                        // Inactive button: normal blue, clickable
                        btn.className = 'btn btn-primary';
                        btn.style.opacity = '1';
                        btn.style.transform = 'scale(1)';
                        btn.disabled = false;
                    }
                }
            }
        }

        async function setMinimumSoc() {
            const el = document.getElementById('battery78-control-msg');
            const socButtons = document.querySelectorAll('[onclick*="MinimumSoc"], [onclick*="resetToFactory"]');
            
            try {
                // Disable SoC buttons and show loading
                socButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.6';
                });
                el.textContent = `‚è≥ Minimum SoC wordt ingesteld...`;
                el.className = 'status-info';
                
                const minSoc = parseFloat(document.getElementById('minSocSlider').value);
                
                const payload = { 
                    min_soc_percent: minSoc, 
                    auto_charge: true  // Always enable auto charge when setting minimum
                };
                
                const res = await fetch('/api/battery/minimum_soc', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const j = await res.json();
                
                if (j.success) {
                    if (j.action_taken === 'emergency_charge') {
                        el.textContent = `‚ö†Ô∏è SoC te laag (${j.current_soc}%) - Noodlading gestart!`;
                        el.className = 'status-warning';
                    } else {
                        el.textContent = `‚úÖ Min SoC: ${minSoc}% ingesteld`;
                        el.className = 'status-good';
                    }
                } else {
                    el.textContent = `Fout: ${j.error || 'onbekend'}`;
                    el.className = 'status-danger';
                }
                setTimeout(refreshData, 1200);
            } catch (e) {
                el.textContent = `‚ùå Fout bij min SoC: ${e}`;
                el.className = 'status-danger';
            } finally {
                // Re-enable SoC buttons after 2 seconds
                setTimeout(() => {
                    socButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    });
                }, 2000);
            }
        }


        async function updateSocProtectionDisplay(batteryData) {
            try {
                // Get current battery config
                const configRes = await fetch('/api/battery/config');
                const configData = await configRes.json();
                
                if (configData.success && batteryData && batteryData.soc_percent) {
                    const currentSoc = batteryData.soc_percent.value;
                    const minSoc = configData.config.minimum_soc_percent;
                    const autoCharge = configData.config.auto_charge_enabled;
                    
                    // Update displays
                    document.getElementById('current-soc-display').textContent = `${currentSoc.toFixed(1)}%`;
                    document.getElementById('active-min-soc').textContent = `${minSoc}%`;
                    
                    // Update slider to match saved config
                    document.getElementById('minSocSlider').value = minSoc;
                    document.getElementById('minSocValue').textContent = `${minSoc}%`;
                    
                    // Update status
                    const statusEl = document.getElementById('soc-protection-status');
                    if (currentSoc <= minSoc) {
                        statusEl.textContent = '‚ö†Ô∏è Te laag - Emergency charge';
                        statusEl.style.color = 'var(--danger-color)';
                    } else if (currentSoc <= minSoc + 2) {
                        statusEl.textContent = '‚ö° Hysteresis zone';
                        statusEl.style.color = 'var(--warning-color)';
                    } else {
                        statusEl.textContent = '‚úÖ Veilig';
                        statusEl.style.color = 'var(--success-color)';
                    }
                }
            } catch (e) {
                console.error('Error updating SoC protection display:', e);
            }
        }

        async function resetToFactory() {
            const el = document.getElementById('battery78-control-msg');
            try {
                // Reset to factory settings: no minimum SoC protection
                const payload = { 
                    min_soc_percent: 15.0,  // Just above hardware limit
                    auto_charge: false      // Disable our protection
                };
                
                // Stop any active force charge first
                const stopRes = await fetch('/api/battery/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'stop' })
                });
                
                // Set factory settings
                const res = await fetch('/api/battery/minimum_soc', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const j = await res.json();
                
                if (j.success) {
                    el.textContent = `üîÑ Reset naar fabrikant - Batterij bepaalt zelf wanneer te stoppen`;
                    el.className = 'status-good';
                    
                    // Update UI
                    document.getElementById('minSocSlider').value = 15;
                    document.getElementById('minSocValue').textContent = '15%';
                } else {
                    el.textContent = `Fout bij reset: ${j.error || 'onbekend'}`;
                    el.className = 'status-danger';
                }
                setTimeout(refreshData, 1200);
            } catch (e) {
                el.textContent = `Fout bij reset naar fabrikant: ${e}`;
                el.className = 'status-danger';
            }
        }

        // --- Main Refresh Logic ---
        async function startAutoRefresh() {
            try {
                // Hide legacy static cards to avoid interference
                const old1 = document.getElementById('battery78-card');
                const old2 = document.getElementById('battery2-card');
                if (old1) old1.style.display = 'none';
                if (old2) old2.style.display = 'none';

                await renderBatteryCards();
                await refreshAllBatteries();
                // Use adaptive interval based on failure count
                function scheduleNextRefresh() {
                    setTimeout(async () => {
                        await refreshAllBatteries();
                        scheduleNextRefresh();
                    }, dashPollInterval);
                }
                scheduleNextRefresh();
            } catch (e) {
                console.error('Init error:', e);
            }
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        }

        let dashFailureCount = 0;
        let dashPollInterval = 5000;
        const dashMaxPollInterval = 30000;

        async function refreshAllBatteries() {
            try {
                const ts = Date.now();
                const statusRes = await fetch(`/api/status?ts=${ts}`, { cache: 'no-store' });
                
                if (!statusRes.ok) {
                    throw new Error(`HTTP ${statusRes.status}`);
                }
                
                const statusData = await statusRes.json();
                updateSystemMetrics(statusData);

                // Loop all rendered cards
                const cards = document.querySelectorAll('[data-bid]');
                for (const card of cards) {
                    const bid = card.getAttribute('data-bid');
                    try {
                        const res = await fetch(`/api/batteries/${bid}/status?ts=${ts}`, { cache: 'no-store' });
                        const data = await res.json();
                        updateBatteryCard(bid, data);
                    } catch (e) {
                        console.warn('Status error for', bid, e);
                    }
                }
                
                // Success: reset failure tracking
                dashFailureCount = 0;
                dashPollInterval = 5000;
                document.title = 'Dashboard - myenergi-marstek';
                
            } catch (error) {
                dashFailureCount++;
                dashPollInterval = Math.min(dashPollInterval * 1.5, dashMaxPollInterval);
                console.error(`Dashboard refresh failed (${dashFailureCount}x): ${error.message}. Retrying in ${dashPollInterval}ms`);
                
                // Show reconnecting indicator after 3 failures
                if (dashFailureCount >= 3) {
                    document.title = '‚ö†Ô∏è Reconnecting...';
                }
            }
        }

        // --- UI Update Functions ---
        function updateBattery78(batteryData) {
            if (batteryData.success && batteryData.data) {
                setBatteryStatus('battery78', 'connected');
                const d = batteryData.derived || {};
                const raw = batteryData.data;

                // SoC
                const socEl = document.getElementById('battery78-soc');
                socEl.textContent = d.soc_percent != null ? `${d.soc_percent.toFixed(1)} %` : '--';
                socEl.className = d.soc_percent > 80 ? 'metric-value status-good' : d.soc_percent > 20 ? 'metric-value status-warning' : 'metric-value status-danger';

                // Energy Remaining
                document.getElementById('battery78-energy').textContent = d.remaining_kwh != null ? `${d.remaining_kwh.toFixed(2)} kWh` : '--';

                // Power
                const powerEl = document.getElementById('battery78-power');
                const power_w = d.power_w;
                if (power_w != null) {
                    powerEl.textContent = `${power_w.toFixed(0)} W`;
                    powerEl.className = power_w > 20 ? 'metric-value status-good' : power_w < -20 ? 'metric-value status-danger' : 'metric-value';
                } else {
                    powerEl.textContent = '--';
                }

                // Update work mode buttons
                if (raw && raw.user_work_mode && raw.user_work_mode.value !== null) {
                    updateWorkModeButtons(raw.user_work_mode.value);
                }

                // Update SoC protection display
                updateSocProtectionDisplay(raw);


                // Current Action (from register 35100)
                const actionEl = document.getElementById('battery78-action');
                if (raw && raw.work_mode && raw.work_mode.formatted) {
                    const modeText = raw.work_mode.formatted;
                    actionEl.textContent = modeText;
                    if (modeText === 'Charging') {
                        actionEl.className = 'metric-value status-good';
                    } else if (modeText === 'Discharging') {
                        actionEl.className = 'metric-value status-danger';
                    } else {
                        actionEl.className = 'metric-value';
                    }
                } else {
                    actionEl.textContent = 'Onbekend';
                }

                // Timestamp
                document.getElementById('battery78-timestamp').textContent = new Date().toLocaleTimeString();

                // RS485 control and setpoints (formatted if available)
                const rs = raw.rs485_control_enable;
                const cmd = raw.control_mode_command;
                const spc = raw.charge_setpoint_power;
                const spd = raw.discharge_setpoint_power;
                document.getElementById('battery78-rs485').textContent = rs ? (rs.formatted || rs.value || '--') : '--';
                document.getElementById('battery78-cmd').textContent = cmd ? (cmd.formatted || cmd.value || '--') : '--';
                document.getElementById('battery78-sp-charge').textContent = spc ? (spc.formatted || `${spc.value} W`) : '--';
                document.getElementById('battery78-sp-discharge').textContent = spd ? (spd.formatted || `${spd.value} W`) : '--';

            } else {
                setBatteryStatus('battery78', 'error');
                console.warn('Battery data error:', batteryData.error);
            }
        }

        function setBatteryStatus(batteryId, status) {
            const card = document.getElementById(`${batteryId}-card`);
            const badge = document.getElementById(`${batteryId}-badge`);
            if (!card || !badge) return;
            ['connected', 'error', 'connecting'].forEach(c => { card.classList.remove(c); badge.classList.remove(c); });
            card.classList.add(status);
            badge.classList.add(status);
            badge.textContent = status;
        }

        // Dynamic battery cards renderer
        async function renderBatteryCards() {
            const containerId = 'batteries-container';
            let container = document.getElementById(containerId);
            if (!container) {
                container = document.createElement('div');
                container.id = containerId;
                container.style.display = 'grid';
                container.style.gridTemplateColumns = '1fr 1fr';
                container.style.gap = '20px';
                container.style.marginTop = '20px';
                document.querySelector('.container').appendChild(container);
            }
            container.innerHTML = '';

            const resp = await fetch('/api/batteries');
            const list = await resp.json();
            if (!list.success || !Array.isArray(list.items)) return;

            for (const it of list.items) {
                const bid = it.id;
                const title = it.name || (bid === 'venus_ev2_92' ? 'Venus EV2 (92)' : bid === 'venus_ev2_74' ? 'Venus EV2 (74)' : bid);
                const idPrefix = `battery-${bid}`;
                const card = document.createElement('div');
                card.className = 'card battery-card connecting';
                card.setAttribute('data-bid', bid);
                card.innerHTML = `
                    <div class="battery-header">
                        <h3>üîã ${title}</h3>
                        <span class="battery-status-badge connecting" id="${idPrefix}-badge">Connecting</span>
                    </div>
                    <div class="metric"><span class="metric-label">State of Charge</span><span class="metric-value status-info" id="${idPrefix}-soc">--</span></div>
                    <div class="metric"><span class="metric-label">Energy Remaining</span><span class="metric-value" id="${idPrefix}-energy">--</span></div>
                    <div class="metric"><span class="metric-label">Battery Power</span><span class="metric-value" id="${idPrefix}-power">--</span></div>
                    <div class="metric"><span class="metric-label">Huidige Actie</span><span class="metric-value" id="${idPrefix}-action">--</span></div>
                    <div class="metric"><span class="metric-label">RS485 Control</span><span class="metric-value" id="${idPrefix}-rs485">--</span></div>
                    <div class="metric"><span class="metric-label">Mode Cmd</span><span class="metric-value" id="${idPrefix}-cmd">--</span></div>
                    <div class="metric"><span class="metric-label">Setpoint Charge</span><span class="metric-value" id="${idPrefix}-sp-charge">--</span></div>
                    <div class="metric"><span class="metric-label">Setpoint Discharge</span><span class="metric-value" id="${idPrefix}-sp-discharge">--</span></div>
                    <div class="metric" style="flex-direction: column; align-items: flex-start; gap:12px; padding-top:15px; border-top: 1px solid var(--border-color); margin-top: 15px;">
                        <span class="metric-label" style="margin-bottom: 8px;">Handmatige Controle</span>
                        <div style="width:100%;">
                            <div style="display:flex; align-items:center; gap:10px; margin-bottom: 10px;">
                                <label style="color:var(--text-secondary);">Power</label>
                                <input id="${idPrefix}-powerSlider" type="range" min="0" max="2000" step="50" value="500" oninput="document.getElementById('${idPrefix}-powerValue').textContent=this.value+' W'" />
                                <span id="${idPrefix}-powerValue" style="min-width:60px; text-align:right; font-weight:600;">500 W</span>
                            </div>
                            <div style="display:flex; flex-wrap:wrap; gap:8px;">
                                <button class="btn btn-success" onclick="batteryControlFor('${bid}','charge')">Force Charge</button>
                                <button class="btn btn-danger" onclick="batteryControlFor('${bid}','discharge')">Force Discharge</button>
                                <button class="btn btn-secondary" onclick="batteryControlFor('${bid}','stop')">Stop Force</button>
                            </div>
                        </div>
                        <div style="width:100%; border-top: 1px solid var(--border-color); margin-top: 15px; padding-top: 15px;">
                            <label style="color:var(--text-secondary); margin-bottom: 5px;">Hoofd Werkmodus</label>
                            <div style="margin-bottom: 10px; font-size: 14px; color: var(--text-primary);">
                                Huidig: <span id="${idPrefix}-current-work-mode" style="font-weight: bold; color: var(--success-color);">-</span>
                            </div>
                            <div style="display:flex; flex-wrap:wrap; gap:8px;">
                                <button id="${idPrefix}-wm-0" data-mode="0" class="btn btn-primary work-mode-btn" onclick="setWorkModeFor('${bid}',0)">Manual</button>
                                <button id="${idPrefix}-wm-1" data-mode="1" class="btn btn-primary work-mode-btn" onclick="setWorkModeFor('${bid}',1)">Anti-Feed</button>
                                <button id="${idPrefix}-wm-2" data-mode="2" class="btn btn-primary work-mode-btn" onclick="setWorkModeFor('${bid}',2)">Trade</button>
                            </div>
                        </div>
                        <div style="width:100%; border-top: 1px solid var(--border-color); margin-top: 15px; padding-top: 15px;">
                            <label style="color:var(--text-secondary); margin-bottom: 5px;">Minimum SoC Bescherming</label>
                            <div style="margin-bottom: 10px; font-size: 14px; color: var(--text-primary);">
                                Huidig SoC: <span id="${idPrefix}-current-soc-display" style="font-weight: bold; color: var(--success-color);">-</span> |
                                Actieve Min: <span id="${idPrefix}-active-min-soc" style="font-weight: bold; color: var(--warning-color);">-</span>
                            </div>
                            <div style="margin-bottom: 10px; font-size: 14px; color: var(--text-primary);">
                                Status: <span id="${idPrefix}-soc-protection-status" style="font-weight: bold;">-</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                                <label style="min-width:80px; font-size:14px;">Min SoC:</label>
                                <input id="${idPrefix}-minSocSlider" type="range" min="15" max="100" step="1" value="20"
                                       oninput="document.getElementById('${idPrefix}-minSocValue').textContent=this.value+'%'" style="flex:1;" />
                                <span id="${idPrefix}-minSocValue" style="min-width:50px; text-align:right; font-weight:600;">20%</span>
                            </div>
                            <div style="display:flex; flex-wrap:wrap; gap:8px;">
                                <button class="btn btn-primary" onclick="setMinimumSocFor('${bid}')">Instellen</button>
                                <button class="btn btn-warning" onclick="resetToFactoryFor('${bid}')">Reset naar Fabrikant</button>
                            </div>
                        </div>
                    </div>
                    <div class="modbus-info">
                        <span id="${idPrefix}-control-msg" style="font-size: 12px;"></span><br>
                        <strong>Last Update:</strong> <span id="${idPrefix}-timestamp">--</span>
                        <div id="${idPrefix}-dbg1" style="margin-top:6px; font-size: 11px; opacity: 0.8;">&nbsp;</div>
                        <div id="${idPrefix}-dbg2" style="font-size: 11px; opacity: 0.8;">&nbsp;</div>
                    </div>
                `;
                document.getElementById('batteries-container') ?
                    container.appendChild(card) : document.querySelector('.container').appendChild(card);
            }
        }

        function updateBatteryCard(bid, batteryData) {
            const idPrefix = `battery-${bid}`;
            const badge = document.getElementById(`${idPrefix}-badge`);
            const card = document.querySelector(`[data-bid="${bid}"]`);
            if (!card) return;
            const setStatus = (status) => {
                if (badge) {
                    ['connected','error','connecting'].forEach(c=>badge.classList.remove(c));
                    badge.classList.add(status);
                    badge.textContent = status.toUpperCase();
                }
                card.classList.remove('connected','error','connecting');
                card.classList.add(status);
            };
            if (batteryData && batteryData.success && batteryData.data) {
                setStatus('connected');
                const d = batteryData.derived || {};
                const raw = batteryData.data || {};
                const socEl = document.getElementById(`${idPrefix}-soc`);
                if (socEl) {
                    let soc = (typeof d.soc_percent === 'number') ? d.soc_percent : (d.soc_percent != null ? Number(d.soc_percent) : null);
                    const key = `${idPrefix}_soc_percent`;
                    const prev = __stable.cache[key];
                    const now = Date.now();
                    // Ignore improbable jump >20%-pt within 15s (transient read glitch)
                    if (prev && soc != null && Math.abs(soc - prev.val) > 20 && (now - prev.ts) < 15000) {
                        soc = prev.val;
                    }
                    if (soc != null) {
                        __stable.cache[key] = { val: soc, ts: now };
                        socEl.textContent = `${soc.toFixed(1)} %`;
                        socEl.className = soc > 80 ? 'metric-value status-good' : soc > 20 ? 'metric-value status-warning' : 'metric-value status-danger';
                    } else {
                        socEl.textContent = '--';
                        socEl.className = 'metric-value';
                    }
                }
                const energyEl = document.getElementById(`${idPrefix}-energy`);
                if (energyEl) energyEl.textContent = d.remaining_kwh != null ? `${d.remaining_kwh.toFixed(2)} kWh` : '--';
                const powerEl = document.getElementById(`${idPrefix}-power`);
                if (powerEl) {
                    const pw = d.power_w;
                    if (pw != null) {
                        powerEl.textContent = `${pw.toFixed(0)} W`;
                        powerEl.className = pw > 20 ? 'metric-value status-good' : pw < -20 ? 'metric-value status-danger' : 'metric-value';
                    } else { powerEl.textContent = '--'; }
                }
                const actionEl = document.getElementById(`${idPrefix}-action`);
                if (actionEl) {
                    const modeText = (raw.work_mode && (raw.work_mode.formatted || raw.work_mode.value)) || (d.mode || 'Onbekend');
                    actionEl.textContent = String(modeText);
                    if (modeText === 'Charging') actionEl.className = 'metric-value status-good';
                    else if (modeText === 'Discharging') actionEl.className = 'metric-value status-danger';
                    else actionEl.className = 'metric-value';
                }
                // Current user-set work mode (if available)
                const currentModeEl = document.getElementById(`${idPrefix}-current-work-mode`);
                let cur = null;
                if (raw && raw.user_work_mode && raw.user_work_mode.value !== null && raw.user_work_mode.value !== undefined) {
                    cur = raw.user_work_mode.value;
                }
                if (currentModeEl && cur !== null) {
                    const mm = {0: 'Manual', 1: 'Anti-Feed', 2: 'Trade'};
                    currentModeEl.textContent = mm[cur] || `Mode ${cur}`;
                }
                // Highlight active work-mode button per card
                const cardEl = document.querySelector(`[data-bid="${bid}"]`);
                if (cardEl) {
                    const buttons = cardEl.querySelectorAll('.work-mode-btn');
                    buttons.forEach(btn => {
                        const m = parseInt(btn.getAttribute('data-mode'), 10);
                        if (cur !== null && m === cur) {
                            btn.className = 'btn btn-success work-mode-btn';
                            btn.disabled = true;
                            btn.style.opacity = '0.9';
                            btn.style.transform = 'scale(0.98)';
                        } else {
                            btn.className = 'btn btn-primary work-mode-btn';
                            btn.disabled = false;
                            btn.style.opacity = '1';
                            btn.style.transform = 'scale(1)';
                        }
                    });
                }
                // RS485/Mode Cmd/Setpoints values (formatted if present)
                const rs = raw && raw.rs485_control_enable;
                const cmd = raw && raw.control_mode_command;
                const spc = raw && raw.charge_setpoint_power;
                const spd = raw && raw.discharge_setpoint_power;
                const rsEl = document.getElementById(`${idPrefix}-rs485`);
                if (rsEl) rsEl.textContent = rs ? (rs.formatted || rs.value || '--') : '--';
                const cmdEl = document.getElementById(`${idPrefix}-cmd`);
                if (cmdEl) cmdEl.textContent = cmd ? (cmd.formatted || cmd.value || '--') : '--';
                const spcEl = document.getElementById(`${idPrefix}-sp-charge`);
                if (spcEl) spcEl.textContent = spc ? (spc.formatted || `${spc.value} W`) : '--';
                const spdEl = document.getElementById(`${idPrefix}-sp-discharge`);
                if (spdEl) spdEl.textContent = spd ? (spd.formatted || `${spd.value} W`) : '--';
                const tsEl = document.getElementById(`${idPrefix}-timestamp`);
                if (tsEl) tsEl.textContent = new Date().toLocaleTimeString();

                // Debug lines
                const dbg1 = document.getElementById(`${idPrefix}-dbg1`);
                const dbg2 = document.getElementById(`${idPrefix}-dbg2`);
                if (dbg1) {
                    const pw = d.power_w != null ? d.power_w.toFixed(0) : '--';
                    const pc = d.calc_power_w != null ? d.calc_power_w.toFixed(0) : '--';
                    dbg1.textContent = `P=${pw}W (calc=${pc}W) | SoC=${d.soc_percent != null ? d.soc_percent.toFixed(1) : '--'}%`;
                }
                if (dbg2) {
                    const uwm = raw && raw.user_work_mode && (raw.user_work_mode.formatted ?? raw.user_work_mode.value);
                    const wmr = raw && raw.work_mode && (raw.work_mode.formatted ?? raw.work_mode.value);
                    dbg2.textContent = `user_mode=${uwm ?? '-'} | device_mode=${wmr ?? '-'}`;
                }

                // Update SoC protection section with config
                updateSocProtectionDisplayFor(bid, d);
            } else {
                setStatus('error');
            }
        }

        // Per-card control with confirmations
        async function batteryControlFor(bid, action) {
            const idPrefix = `battery-${bid}`;
            const el = document.getElementById(`${idPrefix}-control-msg`);
            const card = document.querySelector(`[data-bid="${bid}"]`);
            const buttons = card ? card.querySelectorAll('.btn') : document.querySelectorAll('.btn');
            try {
                buttons.forEach(btn => { btn.disabled = true; btn.style.opacity = '0.6'; });
                if (el) { el.textContent = `‚è≥ ${action} wordt uitgevoerd...`; el.className = 'status-info'; }
                // Read slider strictly from this card to prevent cross-talk
                const powerEl = card ? card.querySelector(`#${idPrefix}-powerSlider`) : document.getElementById(`${idPrefix}-powerSlider`);
                const power_w = powerEl ? parseInt(powerEl.value, 10) : undefined;
                const payload = power_w != null ? { action, power_w } : { action };
                const res = await fetch(`/api/batteries/${bid}/control`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                const j = await res.json();
                if (el) {
                    if (j.success) { el.textContent = `‚úÖ ${action} succesvol`; el.className = 'status-good'; }
                    else { el.textContent = `‚ùå Fout: ${j.error || 'onbekend'}`; el.className = 'status-danger'; }
                }
                setTimeout(() => refreshAllBatteries && refreshAllBatteries(), 1200);
            } catch (e) {
                if (el) { el.textContent = `‚ùå Fout bij ${action}: ${e}`; el.className = 'status-danger'; }
            } finally {
                setTimeout(() => { buttons.forEach(btn => { btn.disabled = false; btn.style.opacity = '1'; }); }, 2000);
            }
        }

        async function setWorkModeFor(bid, mode) {
            const idPrefix = `battery-${bid}`;
            const el = document.getElementById(`${idPrefix}-control-msg`);
            const card = document.querySelector(`[data-bid="${bid}"]`);
            const buttons = card ? card.querySelectorAll('.btn') : document.querySelectorAll('.btn');
            try {
                buttons.forEach(btn => { btn.disabled = true; btn.style.opacity = '0.6'; });
                if (el) { el.textContent = `‚è≥ Werkmodus wordt ingesteld...`; el.className = 'status-info'; }
                const res = await fetch(`/api/batteries/${bid}/mode`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ mode })
                });
                const j = await res.json();
                if (el) {
                    if (j.success) { el.textContent = `‚úÖ Werkmodus gezet`; el.className = 'status-good'; }
                    else { el.textContent = `‚ùå Fout: ${j.error || 'onbekend'}`; el.className = 'status-danger'; }
                }
                setTimeout(() => refreshAllBatteries && refreshAllBatteries(), 1200);
            } catch (e) {
                if (el) { el.textContent = `‚ùå Fout bij werkmodus: ${e}`; el.className = 'status-danger'; }
            } finally {
                setTimeout(() => { buttons.forEach(btn => { btn.disabled = false; btn.style.opacity = '1'; }); }, 2000);
            }
        }

        // --- Minimum SoC per battery ---
        async function updateSocProtectionDisplayFor(bid, derived) {
            try {
                const idPrefix = `battery-${bid}`;
                const cfgRes = await fetch(`/api/batteries/${bid}/config`, { cache: 'no-store' });
                const cfg = await cfgRes.json();
                if (!cfg.success) return;
                const c = cfg.config || {};
                const curSocEl = document.getElementById(`${idPrefix}-current-soc-display`);
                const activeMinEl = document.getElementById(`${idPrefix}-active-min-soc`);
                const statusEl = document.getElementById(`${idPrefix}-soc-protection-status`);
                const slider = document.getElementById(`${idPrefix}-minSocSlider`);
                const sliderVal = document.getElementById(`${idPrefix}-minSocValue`);
                if (slider && (c.minimum_soc_percent != null)) slider.value = c.minimum_soc_percent;
                if (sliderVal) sliderVal.textContent = `${(c.minimum_soc_percent ?? slider?.value) ?? '-'}%`;
                if (activeMinEl) activeMinEl.textContent = `${(c.minimum_soc_percent ?? '-')}%`;
                if (curSocEl && derived && derived.soc_percent != null) curSocEl.textContent = `${derived.soc_percent.toFixed(1)}%`;
                if (statusEl && derived && derived.soc_percent != null && (c.minimum_soc_percent != null)) {
                    const soc = derived.soc_percent;
                    const min = c.minimum_soc_percent;
                    if (soc <= min) { statusEl.textContent = '‚ö†Ô∏è Te laag - Emergency charge'; statusEl.style.color = 'var(--status-yellow)'; }
                    else if (soc <= min + 2) { statusEl.textContent = '‚ö° Hysteresis zone'; statusEl.style.color = 'var(--status-yellow)'; }
                    else { statusEl.textContent = '‚úÖ Veilig'; statusEl.style.color = 'var(--status-green)'; }
                }
            } catch (e) {
                console.warn('SoC display update failed for', bid, e);
            }
        }

        async function setMinimumSocFor(bid) {
            const idPrefix = `battery-${bid}`;
            const card = document.querySelector(`[data-bid="${bid}"]`);
            const el = document.getElementById(`${idPrefix}-control-msg`);
            const buttons = card ? card.querySelectorAll('.btn') : document.querySelectorAll('.btn');
            try {
                buttons.forEach(b=>{b.disabled=true;b.style.opacity='0.6'});
                if (el) { el.textContent = '‚è≥ Minimum SoC wordt ingesteld...'; el.className='status-info'; }
                const slider = document.getElementById(`${idPrefix}-minSocSlider`);
                const minSoc = slider ? parseFloat(slider.value) : 20;
                const res = await fetch(`/api/batteries/${bid}/minimum_soc`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ min_soc_percent: minSoc, auto_charge: true })});
                const j = await res.json();
                if (el) {
                    if (j.success) {
                        if (j.action_taken === 'emergency_charge') { el.textContent = `‚ö†Ô∏è SoC te laag (${j.current_soc}%) - Noodlading gestart!`; el.className='status-warning'; }
                        else { el.textContent = `‚úÖ Min SoC: ${minSoc}% ingesteld`; el.className='status-good'; }
                    } else { el.textContent = `‚ùå Fout: ${j.error || 'onbekend'}`; el.className='status-danger'; }
                }
                setTimeout(()=>refreshAllBatteries && refreshAllBatteries(), 1200);
            } catch (e) {
                if (el) { el.textContent = `‚ùå Fout bij min SoC: ${e}`; el.className='status-danger'; }
            } finally {
                setTimeout(()=>{buttons.forEach(b=>{b.disabled=false;b.style.opacity='1'})},2000);
            }
        }

        async function resetToFactoryFor(bid) {
            const idPrefix = `battery-${bid}`;
            const card = document.querySelector(`[data-bid="${bid}"]`);
            const el = document.getElementById(`${idPrefix}-control-msg`);
            const buttons = card ? card.querySelectorAll('.btn') : document.querySelectorAll('.btn');
            try {
                buttons.forEach(b=>{b.disabled=true;b.style.opacity='0.6'});
                if (el) { el.textContent = '‚è≥ Reset naar fabrikant...'; el.className='status-info'; }
                // Stop any active force first (best effort)
                await fetch(`/api/batteries/${bid}/control`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ action:'stop' })});
                const res = await fetch(`/api/batteries/${bid}/minimum_soc`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ min_soc_percent: 15.0, auto_charge: false })});
                const j = await res.json();
                if (el) {
                    if (j.success) { el.textContent = 'üîÑ Reset naar fabrikant - Batterij bepaalt zelf wanneer te stoppen'; el.className='status-good'; }
                    else { el.textContent = `‚ùå Fout bij reset: ${j.error || 'onbekend'}`; el.className='status-danger'; }
                }
                setTimeout(()=>refreshAllBatteries && refreshAllBatteries(), 1200);
            } catch (e) {
                if (el) { el.textContent = `‚ùå Fout bij reset: ${e}`; el.className='status-danger'; }
            } finally {
                setTimeout(()=>{buttons.forEach(b=>{b.disabled=false;b.style.opacity='1'})},2000);
            }
        }

        function updateSystemMetrics(data) {
            // PV Generation (zero-aware)
            const pv_raw = Number(data.pv_generation_w || 0);
            const pv_w = __stable.numZeroAware('pv_w', pv_raw, { ttlMs: 6000, confirmZeros: 2 });
            document.getElementById('pvGeneration').textContent = `${pv_w}W`;
            document.getElementById('pvStatus').textContent = pv_w > 100 ? 'Actief' : 'Laag';

            // Grid Import/Export (signed), zero-aware
            const grid_signed = (data.grid_import_w != null ? Number(data.grid_import_w)
                                : (data.grid_export_w != null ? Number(data.grid_export_w)
                                : Number(data.grid_w || 0)));
            const grid_w = __stable.numZeroAware('grid_w', grid_signed, { ttlMs: 6000, confirmZeros: 2 });
            const gridEl = document.getElementById('gridExport');
            gridEl.textContent = grid_w > 0 ? `${grid_w}W (Import)` : grid_w < 0 ? `${Math.abs(grid_w)}W (Export)` : '0W';
            gridEl.className = `metric-value ${grid_w > 10 ? 'status-warning' : grid_w < -10 ? 'status-good' : ''}`;
            document.getElementById('gridStatus').textContent = grid_w > 100 ? 'Importeren' : grid_w < -100 ? 'Exporteren' : 'Neutraal';

            // House Consumption (zero-aware)
            const house_w = __stable.numZeroAware('house_w', Number(data.house_consumption_w || 0), { ttlMs: 6000, confirmZeros: 2 });
            document.getElementById('houseConsumption').textContent = `${house_w}W`;
            document.getElementById('houseStatus').textContent = house_w > 1000 ? 'Hoog' : 'Normaal';

            // Eddi Status
            const eddi_w = __stable.numZeroAware('eddi_w', Number(data.eddi_power_w || 0), { ttlMs: 6000, confirmZeros: 2 });
            document.getElementById('eddiPower').textContent = `${eddi_w}W`;
            const temps = data.eddi_temperatures || {};
            document.getElementById('tank1Temp').textContent = temps.tank1 != null ? `${temps.tank1}¬∞C` : 'N/A';
            document.getElementById('tank2Temp').textContent = temps.tank2 != null ? `${temps.tank2}¬∞C` : 'N/A';

            // Zappi Status
            const zappi_w = __stable.numZeroAware('zappi_w', Number(data.zappi_power_w || 0), { ttlMs: 6000, confirmZeros: 2 });
            document.getElementById('zappiPower').textContent = `${zappi_w}W`;
        }

        // --- Initializer ---
        document.addEventListener('DOMContentLoaded', startAutoRefresh);
        document.getElementById('autoRefresh').addEventListener('change', (e) => e.target.checked ? startAutoRefresh() : stopAutoRefresh());
    </script>

    <!-- Backend Health & Logs -->
    <script>
        // Debounced health state to prevent flicker
        const __healthClient = { lastOkTs: 0, consecutiveFails: 0 };
        function renderHealthBadge(state){
            const b = document.getElementById('backendHealthBadge');
            if(!b) return;
            const now = Date.now()/1000;
            const sinceOk = now - (state.lastOkTs || 0);
            // Rules: OK if success in last 20s; Degraded if >=3 fails in a row or >60s since last OK; else Unknown
            let label = 'Backend: Unknown';
            let cls = 'badge degraded';
            if (sinceOk <= 20) { label = 'Backend: OK'; cls = 'badge ok'; }
            else if (state.consecutiveFails >= 3 || sinceOk > 60) { label = 'Backend: Degraded'; cls = 'badge degraded'; }
            else { label = 'Backend: Unknown'; cls = 'badge degraded'; }
            b.textContent = label;
            b.className = cls;
        }
        async function updateBackendHealthBadge(){
            try{
                const r = await fetch('/api/health', {cache:'no-store'});
                const j = await r.json();
                if(j.success && j.simple_rule){
                    const health = (j.simple_rule.last && j.simple_rule.last.health) || {};
                    const ok = health && health.myenergi_ok === true;
                    if (ok) { __healthClient.lastOkTs = Date.now()/1000; __healthClient.consecutiveFails = 0; }
                    else { __healthClient.consecutiveFails = (__healthClient.consecutiveFails||0) + 1; }
                } else {
                    __healthClient.consecutiveFails = (__healthClient.consecutiveFails||0) + 1;
                }
            }catch(e){
                __healthClient.consecutiveFails = (__healthClient.consecutiveFails||0) + 1;
            }
            renderHealthBadge(__healthClient);
        }
        setInterval(updateBackendHealthBadge, 5000);
        document.addEventListener('DOMContentLoaded', updateBackendHealthBadge);

        let __lastLogsLines = [];
        function filterImportantLogs(lines){
            const wanted = [
                /error/i,
                /exception/i,
                /traceback/i,
                /‚ùå/,
                /üî•\s*EDDI PRIORITY/i,
                /üéØ\s*RULE EXEC/i,
                /üîç\s*RULES DEBUG/i,
                /‚úÖ Battery|‚ùå Battery|set battery/i,
            ];
            const noisy = [
                /GET \/api\/status/i,
                /uvicorn|httpx|anyio|starlette|fastapi.*INFO/i,
            ];
            return lines.filter(ln => {
                if (noisy.some(r=>r.test(ln))) return false;
                return wanted.some(r=>r.test(ln));
            });
        }

        async function openLogsModal(){
            console.log('openLogsModal: clicked');
            const modal = document.getElementById('logsModal');
            const pre = document.getElementById('logsContent');
            if(!modal){ return; }
            pre && (pre.textContent = 'Laden...');
            modal.classList.add('open');
            modal.style.display = 'flex';
            try{
                const r = await fetch('/api/logs/tail?n=300', {cache:'no-store'});
                const j = await r.json();
                if(j.success){
                    __lastLogsLines = (j.lines || []);
                    renderLogs();
                }else{
                    pre.textContent = 'Kon logs niet laden: '+(j.error||'onbekend');
                }
            }catch(e){
                if(pre) pre.textContent = 'Fout bij laden logs: '+e;
            }
        }
        function closeLogsModal(){
            const modal = document.getElementById('logsModal');
            if(modal){ modal.classList.remove('open'); modal.style.display = 'none'; }
        }
        function renderLogs(){
            const pre = document.getElementById('logsContent');
            const only = document.getElementById('logsImportantOnly');
            if(!pre) return;
            let lines = __lastLogsLines || [];
            if(only && only.checked){
                lines = filterImportantLogs(lines);
            }
            pre.textContent = lines.length ? lines.join('\n') : '(geen relevante regels)';
        }
        // Ensure button is wired even if inline handlers fail
        document.addEventListener('DOMContentLoaded', ()=>{
            const btn = document.getElementById('btnLogs');
            if(btn){ btn.addEventListener('click', openLogsModal); }
            const chk = document.getElementById('logsImportantOnly');
            if(chk){ chk.addEventListener('change', renderLogs); }
        });
    </script>
</body>
</html>
                
                <!-- Simple Rule Toggle -->
                <div style="background: var(--bg-color); border-radius: 12px; padding: 30px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px;">
                        <span style="font-size: 18px; font-weight: 600;">üî• Eddi krijgt altijd voorrang</span>
                        
                        <!-- Beautiful Toggle Switch -->
                        <label class="toggle-switch">
                            <input type="checkbox" id="eddiPriorityToggle" onchange="toggleRule()" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        
                        <span id="ruleStatus" style="font-size: 16px; font-weight: 600; color: var(--success-color);">AAN</span>
                    </div>
                    
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">
                        Batterijen laden alleen uit overschot dat Eddi niet nodig heeft
                    </div>
                    <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 25px;">
                        Let op: deze regels-UI is (nog) niet actief in de backend. De Simple Rule bestuurt nu de batterijen.
                    </div>
                    
                    <!-- Battery selection UI removed -->
                    
                    <!-- Temperature override testing UI removed -->
                    
                    <!-- Rule Status -->
                    <div style="margin-top: 20px; padding: 15px; background: var(--info-color); color: white; border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 5px;">üìä Huidige Status (Rules UI):</div>
                        <div id="currentRuleStatus">Deze status is informatief; backend rules-engine staat uit. Simple Rule is actief.</div>
                    </div>
                </div>
            </div>
        </div>
        
        <style>
        /* Beautiful Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--success-color);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* Battery Toggle Cards */
        .battery-toggle {
            cursor: pointer;
        }
        
        .battery-toggle input {
            display: none;
        }
        
        .battery-card {
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            background: var(--bg-color);
            color: var(--text-primary);
            min-width: 120px;
        }
        
        .battery-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,255,255,0.1);
            border-color: var(--info-color);
        }
        
        .battery-toggle input:checked + .battery-card {
            border-color: var(--success-color);
            background: var(--success-color);
            color: white;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
        }
        
        .battery-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .battery-card.disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        .battery-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .battery-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .battery-status {
            font-size: 12px;
            opacity: 0.8;
        }
        </style>

        <script>
        // Simple Rules Management
        async function toggleRule() {
            const toggle = document.getElementById("eddiPriorityToggle");
            const status = document.getElementById("ruleStatus");
            
            const isActive = toggle.checked;
            status.textContent = isActive ? "AAN" : "UIT";
            status.style.color = isActive ? "var(--success-color)" : "var(--text-secondary)";
            
            await updateRuleConfig();
        }
        
        // Battery selection removed
        
        // Temperature override removed
        
        async function updateRuleConfig() {
            try {
                const ruleActive = document.getElementById("eddiPriorityToggle").checked;
                // Hardcode which batteries participate
                const battery1 = true; // venus_e_78 actief
                const battery2 = false; // wifi_converter uit
                
                const config = {
                    "rules": [
                        {
                            "id": "eddi_priority",
                            "name": "üî• Eddi Prioriteit",
                            "description": "Eddi krijgt altijd voorrang, batterijen laden alleen uit restant overschot",
                            "active": ruleActive,
                            "batteries": {
                                "venus_e_78": battery1,
                                "wifi_converter": battery2
                            },
                            "parameters": {
                                "export_threshold_w": 100,
                                "eddi_buffer_w": 200,
                                "max_battery_power_w": 1500,
                                "hysteresis_seconds": 5,
                                "cooldown_seconds": 10
                            }
                        }
                    ],
                    "global_settings": {
                        "check_interval_seconds": 2,
                        "min_soc_failsafe": 15,
                        "last_updated": null
                    }
                };
                
                const response = await fetch("/api/energy_rules", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log("‚úÖ Rules updated successfully");
                    await updateRuleStatus();
                } else {
                    console.error("‚ùå Failed to update rules:", result.error);
                }
                
            } catch (error) {
                console.error("‚ùå Error updating rules:", error);
            }
        }
        
        async function updateRuleStatus() {
            try {
                const response = await fetch("/api/rules/status");
                const result = await response.json();
                
                if (result.success) {
                    const statusEl = document.getElementById("currentRuleStatus");
                    const mode = result.current_mode;
                    const override = result.user_override;
                    const rulesCount = result.active_rules_count;
                    
                    let statusText = "";
                    if (override) {
                        statusText = "üë§ Handmatige controle actief";
                    } else if (rulesCount > 0) {
                        statusText = `ü§ñ ${rulesCount} regel(s) actief - Mode: ${mode}`;
                    } else {
                        statusText = "üîã Batterij controleert zichzelf (Anti-Feed)";
                    }
                    
                    statusEl.textContent = statusText;
                }
            } catch (error) {
                console.error("‚ùå Error getting rule status:", error);
            }
        }
        
        // Load current rules on page load
        async function loadCurrentRules() {
            try {
                const response = await fetch("/api/energy_rules");
                const result = await response.json();
                
                if (result.success && result.data.rules.length > 0) {
                    const rule = result.data.rules[0];
                    // Set toggle state for eddi priority only
                    document.getElementById("eddiPriorityToggle").checked = rule.active;
                    
                    // Update status
                    const status = document.getElementById("ruleStatus");
                    status.textContent = rule.active ? "AAN" : "UIT";
                    status.style.color = rule.active ? "var(--success-color)" : "var(--text-secondary)";
                }
                
                await updateRuleStatus();
            } catch (error) {
                console.error("‚ùå Error loading rules:", error);
            }
        }
        
        // Auto-refresh rule status
        setInterval(updateRuleStatus, 5000);  // Every 5 seconds
        
        // Load rules when page loads
        document.addEventListener("DOMContentLoaded", loadCurrentRules);
        
        </script>

    <!-- Simple Battery Rule JS -->
    <script>
        // Update the Simple Battery Rule card from backend
        async function updateSimpleRuleStatus() {
            try {
                const res = await fetch('/api/simple_rule/status', { cache: 'no-store' });
                const j = await res.json();
                const btn = document.getElementById('simple-rule-toggle');
                const st = document.getElementById('simple-rule-state');
                if (!j || !j.success) {
                    if (st) { st.textContent = 'Fout'; st.className = 'status-danger'; }
                    return;
                }
                const en = !!j.enabled;
                if (btn) btn.textContent = en ? 'UIT' : 'AAN';
                if (st) { st.textContent = en ? 'Aan' : 'Uit'; st.className = en ? 'status-good' : 'status-info'; }
                const last = j.last || {};
                const cfg  = j.cfg  || {};
                const grid = document.getElementById('sr-grid');
                const over = document.getElementById('sr-overschot');
                const tex  = document.getElementById('sr-target-export');
                const ttot = document.getElementById('sr-target-total');
                const stot = document.getElementById('sr-set-total');
                const cool = document.getElementById('sr-cooldown');
                const per  = document.getElementById('sr-per-batt');
                const sr_grid_w = __stable.numZeroAware('sr_grid_w', Number(last.grid_w || 0), { ttlMs: 6000, confirmZeros: 2 });
                const sr_over_w = __stable.numZeroAware('sr_over_w', Number(last.overschot_w || 0), { ttlMs: 6000, confirmZeros: 2 });
                const sr_tex_w  = (cfg.buffer_w != null && cfg.export_margin_w != null) ? (Number(cfg.buffer_w) + Number(cfg.export_margin_w)) : null;
                const sr_ttot_w = __stable.numZeroAware('sr_ttot_w', Number(last.batt_target_total_w || 0), { ttlMs: 6000, confirmZeros: 2 });
                const sr_stot_w = __stable.numZeroAware('sr_stot_w', Number(last.batt_set_total_w || 0), { ttlMs: 6000, confirmZeros: 2 });
                if (grid) grid.textContent = (last.grid_w != null) ? `${sr_grid_w} W` : '--';
                if (over) over.textContent = (last.overschot_w != null) ? `${sr_over_w} W` : '--';
                if (tex)  tex.textContent  = (sr_tex_w != null) ? `${sr_tex_w} W` : '--';
                if (ttot) ttot.textContent = (last.batt_target_total_w != null) ? `${sr_ttot_w} W` : '--';
                if (stot) stot.textContent = (last.batt_set_total_w != null) ? `${sr_stot_w} W` : '--';
                if (cool) cool.textContent = last.cooldown ? 'Actief' : 'Nee';
                if (per)  {
                    const p = last.per_battery || {};
                    const lines = Object.keys(p).map(k => {
                        const key = `sr_pb_${k}_set`;
                        const setVal = __stable.numZeroAware(key, Number(p[k].set || 0), { ttlMs: 6000, confirmZeros: 2 });
                        return `${k}: ${setVal}W ${p[k].ok ? '‚úÖ' : '‚ùå'}`;
                    });
                    per.textContent = lines.length ? lines.join('  |  ') : '--';
                }
            } catch (e) {
                const st = document.getElementById('simple-rule-state');
                if (st) { st.textContent = 'Fout'; st.className = 'status-danger'; }
            }
        }

        // Toggle enable/disable of the Simple Battery Rule
        async function toggleSimpleRule() {
            try {
                const st = await fetch('/api/simple_rule/status');
                const js = await st.json();
                const enabled = !!js.enabled;
                if (enabled) {
                    await fetch('/api/simple_rule/disable', { method: 'POST' });
                } else {
                    await fetch('/api/simple_rule/enable', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) });
                }
                setTimeout(updateSimpleRuleStatus, 300);
            } catch (e) {
                console.error('toggleSimpleRule error', e);
            }
        }

        // Poll the status to keep the card updated
        setInterval(updateSimpleRuleStatus, 2000);
        document.addEventListener('DOMContentLoaded', updateSimpleRuleStatus);
    </script>



