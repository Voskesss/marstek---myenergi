<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>myenergi ‚Üî Marstek Live Dashboard</title>
    <style>
        :root {
            --bg-color: #0f172a; /* slate-900 */
            --card-bg: #1e293b; /* slate-800 */
            --border-color: #334155; /* slate-700 */
            --text-primary: #f1f5f9; /* slate-100 */
            --text-secondary: #94a3b8; /* slate-400 */
            --text-tertiary: #64748b; /* slate-500 */
            --accent-blue: #3b82f6;
            --status-green: #22c55e;
            --status-yellow: #f59e0b;
            --status-red: #ef4444;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--bg-color);
            color: var(--text-primary);
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: var(--text-primary); }
        .header p { color: var(--text-secondary); }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); }
        .card h3 { margin: 0 0 15px 0; color: var(--text-primary); font-size: 18px; font-weight: 600; }
        .metric { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .metric:last-child { border-bottom: none; }
        .metric-label { font-weight: 500; color: var(--text-secondary); }
        .metric-value { font-weight: 600; font-size: 18px; }
        .status-good { color: var(--status-green); }
        .status-warning { color: var(--status-yellow); }
        .status-danger { color: var(--status-red); }
        .status-info { color: var(--accent-blue); }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-success { background: var(--status-green); color: white; }
        .btn-danger { background: var(--status-red); color: white; }
        .btn-warning { background: var(--status-yellow); color: #1e293b; }
        .btn-secondary { background: var(--border-color); color: var(--text-primary); }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .auto-refresh { text-align: center; margin-bottom: 20px; padding: 10px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color); }
        .battery-card { border: 2px solid var(--border-color); transition: border-color 0.3s; }
        .battery-card.connected { border-color: var(--status-green); }
        .battery-card.error { border-color: var(--status-red); }
        .battery-card.connecting { border-color: var(--status-yellow); }
        .battery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .battery-status-badge { padding: 4px 10px; border-radius: 99px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
        .battery-status-badge.connected { background: var(--status-green); color: var(--bg-color); }
        .battery-status-badge.error { background: var(--status-red); color: white; }
        .battery-status-badge.connecting { background: var(--status-yellow); color: var(--bg-color); }
        .modbus-info { font-size: 12px; color: var(--text-tertiary); margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        input[type=range] { -webkit-appearance: none; appearance: none; width: 100%; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { background: var(--border-color); height: 4px; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: var(--accent-blue); cursor: pointer; margin-top: -7px; }
        pre { white-space:pre-wrap; word-break:break-word; background:#0b1220; padding:12px; border-radius:8px; border:1px solid #1f2937; color: var(--text-secondary); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîã myenergi ‚Üî Marstek Live Dashboard</h1>
            <p>Real-time monitoring en controle van je energie systeem</p>
        </div>
        
        <div class="auto-refresh">
            <label>
                <input type="checkbox" id="autoRefresh" checked> Auto-refresh (5s)
            </label>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="refreshData()">üîÑ Refresh Nu</button>
            <button class="btn btn-warning" onclick="restartApplication()">üîÑ Restart App</button>
            <button class="btn btn-secondary" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <!-- Column 1: System Overview -->
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div class="card">
                    <h3>‚òÄÔ∏è PV Generatie</h3>
                    <div class="metric"><span class="metric-label">Opwekking</span><span class="metric-value" id="pvGeneration">-</span></div>
                    <div class="metric"><span class="metric-label">Status</span><span class="metric-value" id="pvStatus">-</span></div>
                </div>
                <div class="card">
                    <h3>‚ö° Grid</h3>
                    <div class="metric"><span class="metric-label">Import/Export</span><span class="metric-value" id="gridExport">-</span></div>
                    <div class="metric"><span class="metric-label">Status</span><span class="metric-value" id="gridStatus">-</span></div>
                </div>
                <div class="card">
                    <h3>üè† Huis Verbruik</h3>
                    <div class="metric"><span class="metric-label">Verbruik</span><span class="metric-value" id="houseConsumption">-</span></div>
                    <div class="metric"><span class="metric-label">Status</span><span class="metric-value" id="houseStatus">-</span></div>
                </div>
                <div class="card">
                    <h3>üî• Eddi (Warmwater)</h3>
                    <div class="metric"><span class="metric-label">Vermogen</span><span class="metric-value" id="eddiPower">-</span></div>
                    <div class="metric"><span class="metric-label">Tank 1 Temp</span><span class="metric-value" id="tank1Temp">-</span></div>
                    <div class="metric"><span class="metric-label">Tank 2 Temp</span><span class="metric-value" id="tank2Temp">-</span></div>
                </div>
                <div class="card">
                    <h3>üöó Zappi (Auto)</h3>
                    <div class="metric"><span class="metric-label">Vermogen</span><span class="metric-value" id="zappiPower">-</span></div>
                </div>
            </div>

            <!-- Column 2: Battery 1 -->
            <div class="card battery-card connecting" id="battery78-card">
                <div class="battery-header">
                    <h3>üîã Venus E Batterij 78</h3>
                    <span class="battery-status-badge connecting" id="battery78-badge">Connecting</span>
                </div>
                <div class="metric"><span class="metric-label">State of Charge</span><span class="metric-value status-info" id="battery78-soc">--</span></div>
                <div class="metric"><span class="metric-label">Energy Remaining</span><span class="metric-value" id="battery78-energy">--</span></div>
                <div class="metric"><span class="metric-label">Battery Power</span><span class="metric-value" id="battery78-power">--</span></div>
                <div class="metric"><span class="metric-label">Huidige Actie</span><span class="metric-value" id="battery78-action">--</span></div>
                <div class="metric"><span class="metric-label">RS485 Control</span><span class="metric-value" id="battery78-rs485">--</span></div>
                <div class="metric"><span class="metric-label">Mode Cmd</span><span class="metric-value" id="battery78-cmd">--</span></div>
                <div class="metric"><span class="metric-label">Setpoint Charge</span><span class="metric-value" id="battery78-sp-charge">--</span></div>
                <div class="metric"><span class="metric-label">Setpoint Discharge</span><span class="metric-value" id="battery78-sp-discharge">--</span></div>

                <!-- CONTROLS -->
                <div class="metric" style="flex-direction: column; align-items: flex-start; gap:12px; padding-top:15px; border-top: 1px solid var(--border-color); margin-top: 15px;">
                    <span class="metric-label" style="margin-bottom: 8px;">Handmatige Controle</span>
                    <div style="width:100%;">
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom: 10px;">
                            <label style="color:var(--text-secondary);">Power</label>
                            <input id="powerSlider" type="range" min="0" max="2000" step="50" value="500" oninput="document.getElementById('powerValue').textContent=this.value+' W'" />
                            <span id="powerValue" style="min-width:60px; text-align:right; font-weight:600;">500 W</span>
                        </div>
                        <div style="display:flex; flex-wrap:wrap; gap:8px;">
                            <button class="btn btn-success" onclick="batteryControl('charge')">Force Charge</button>
                            <button class="btn btn-danger" onclick="batteryControl('discharge')">Force Discharge</button>
                            <button class="btn btn-secondary" onclick="batteryControl('stop')">Stop Force</button>
                        </div>
                    </div>
                    <div style="width:100%; border-top: 1px solid var(--border-color); margin-top: 15px; padding-top: 15px;">
                         <label style="color:var(--text-secondary); margin-bottom: 5px;">Hoofd Werkmodus</label>
                         <div style="margin-bottom: 10px; font-size: 14px; color: var(--text-primary);">
                            Huidig: <span id="current-work-mode" style="font-weight: bold; color: var(--success-color);">-</span>
                         </div>
                        <div style="display:flex; flex-wrap:wrap; gap:8px;">
                            <button id="work-mode-0" class="btn btn-primary" onclick="setWorkMode(0)">Manual</button>
                            <button id="work-mode-1" class="btn btn-primary" onclick="setWorkMode(1)">Anti-Feed</button>
                            <button id="work-mode-2" class="btn btn-primary" onclick="setWorkMode(2)">Trade</button>
                        </div>
                    </div>
                    <div style="width:100%; border-top: 1px solid var(--border-color); margin-top: 15px; padding-top: 15px;">
                         <label style="color:var(--text-secondary); margin-bottom: 5px;">Minimum SoC Bescherming</label>
                         <div style="margin-bottom: 10px; font-size: 14px; color: var(--text-primary);">
                            Huidig SoC: <span id="current-soc-display" style="font-weight: bold; color: var(--success-color);">-</span> |
                            Actieve Min: <span id="active-min-soc" style="font-weight: bold; color: var(--warning-color);">-</span>
                         </div>
                         <div style="margin-bottom: 10px; font-size: 14px; color: var(--text-primary);">
                            Status: <span id="soc-protection-status" style="font-weight: bold;">-</span>
                         </div>
                         <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                            <label style="min-width:80px; font-size:14px;">Min SoC:</label>
                            <input id="minSocSlider" type="range" min="15" max="100" step="1" value="20" 
                                   oninput="document.getElementById('minSocValue').textContent=this.value+'%'" 
                                   style="flex:1;" />
                            <span id="minSocValue" style="min-width:50px; text-align:right; font-weight:600;">20%</span>
                         </div>
                         <div style="display:flex; flex-wrap:wrap; gap:8px;">
                            <button class="btn btn-primary" onclick="setMinimumSoc()">Instellen</button>
                            <button class="btn btn-warning" onclick="resetToFactory()">Reset naar Fabrikant</button>
                         </div>
                    </div>
                </div>
                <div class="modbus-info">
                    <span id="battery78-control-msg" style="font-size: 12px;"></span><br>
                    <strong>Last Update:</strong> <span id="battery78-timestamp">--</span>
                </div>
            </div>

            <!-- Column 3: Battery 2 (WiFi Converter) -->
            <div class="card battery-card connecting" id="battery2-card">
                <div class="battery-header">
                    <h3>üîã Batterij 2 (WiFi Converter)</h3>
                    <span class="battery-status-badge connecting" id="battery2-badge">Connecting</span>
                </div>
                <div class="metric"><span class="metric-label">State of Charge</span><span class="metric-value status-info" id="battery2-soc">--</span></div>
                <div class="metric"><span class="metric-label">Energy Remaining</span><span class="metric-value" id="battery2-energy">--</span></div>
                <div class="metric"><span class="metric-label">Battery Power</span><span class="metric-value" id="battery2-power">--</span></div>
                <div class="metric"><span class="metric-label">Huidige Actie</span><span class="metric-value" id="battery2-action">--</span></div>
                <div class="metric"><span class="metric-label">IP</span><span class="metric-value" id="battery2-ip">--</span></div>
                <div class="metric"><span class="metric-label">Port</span><span class="metric-value" id="battery2-port">--</span></div>
                <div class="modbus-info">
                    <strong>Last Update:</strong> <span id="battery2-timestamp">--</span>
                </div>
            </div>
        </div>
        
        <!-- Energy Management Rules -->
        <div class="card" style="margin-bottom: 20px;">
                
            
        </div>
        
    </div>

    <script>
        let autoRefreshInterval;

        // --- API Wrappers ---
        async function setWorkMode(mode) {
            const el = document.getElementById('battery78-control-msg');
            const workModeButtons = document.querySelectorAll('[id^="work-mode-"]');
            
            try {
                // Disable work mode buttons and show loading
                workModeButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.6';
                });
                el.textContent = `‚è≥ Werkmodus wordt ingesteld...`;
                el.className = 'status-info';
                
                const res = await fetch('/api/battery/set_work_mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode })
                });
                const j = await res.json();
                if (j.success) {
                    const modeMap = {0: 'Manual', 1: 'Anti-Feed', 2: 'Trade Mode'};
                    el.textContent = `‚úÖ Werkmodus: ${modeMap[mode]}`;
                    el.className = 'status-good';
                } else {
                    el.textContent = `‚ùå Fout: ${j.error || 'onbekend'}`;
                    el.className = 'status-danger';
                }
                setTimeout(refreshData, 1200);
            } catch (e) {
                el.textContent = `‚ùå Fout bij werkmodus: ${e}`;
                el.className = 'status-danger';
            } finally {
                // Re-enable work mode buttons after 2 seconds
                setTimeout(() => {
                    workModeButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    });
                }, 2000);
            }
        }

        function updateBattery2(batteryData) {
            const prefix = 'battery2';
            if (batteryData && batteryData.success && batteryData.data) {
                setBatteryStatus(prefix, 'connected');
                const d = batteryData.derived || {};
                const raw = batteryData.data || {};

                // SoC
                const socEl = document.getElementById(`${prefix}-soc`);
                if (socEl) {
                    const soc = d.soc_percent;
                    socEl.textContent = soc != null ? `${soc.toFixed(1)} %` : '--';
                    socEl.className = soc > 80 ? 'metric-value status-good' : soc > 20 ? 'metric-value status-warning' : 'metric-value status-danger';
                }

                // Energy Remaining
                const energyEl = document.getElementById(`${prefix}-energy`);
                if (energyEl && d.remaining_kwh != null) energyEl.textContent = `${d.remaining_kwh.toFixed(2)} kWh`;

                // Power
                const powerEl = document.getElementById(`${prefix}-power`);
                if (powerEl) {
                    const pw = d.power_w;
                    if (pw != null) {
                        powerEl.textContent = `${pw.toFixed(0)} W`;
                        powerEl.className = pw > 20 ? 'metric-value status-good' : pw < -20 ? 'metric-value status-danger' : 'metric-value';
                    } else {
                        powerEl.textContent = '--';
                    }
                }

                // Mode/Action
                const actionEl = document.getElementById(`${prefix}-action`);
                if (actionEl) {
                    const modeText = (raw.work_mode && (raw.work_mode.formatted || raw.work_mode.value)) || (d.mode || 'Onbekend');
                    actionEl.textContent = String(modeText);
                    if (modeText === 'Charging') actionEl.className = 'metric-value status-good';
                    else if (modeText === 'Discharging') actionEl.className = 'metric-value status-danger';
                    else actionEl.className = 'metric-value';
                }

                // Timestamp
                const tsEl = document.getElementById(`${prefix}-timestamp`);
                if (tsEl) tsEl.textContent = new Date().toLocaleTimeString();
            } else {
                setBatteryStatus(prefix, 'error');
            }
        }

        async function batteryControl(action) {
            const el = document.getElementById('battery78-control-msg');
            const buttons = document.querySelectorAll('.btn');
            
            try {
                // Disable all buttons and show loading
                buttons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.6';
                });
                el.textContent = `‚è≥ ${action} wordt uitgevoerd...`;
                el.className = 'status-info';
                
                const power_w = parseInt(document.getElementById('powerSlider').value, 10);
                const payload = { action, power_w };
                const res = await fetch('/api/battery/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const j = await res.json();
                if (j.success) {
                    el.textContent = `‚úÖ ${j.action} succesvol uitgevoerd`;
                    el.className = 'status-good';
                } else {
                    el.textContent = `‚ùå Fout: ${j.error || 'onbekend'}`;
                    el.className = 'status-danger';
                }
                setTimeout(refreshData, 1200);
            } catch (e) {
                el.textContent = `‚ùå Fout bij ${action}: ${e}`;
                el.className = 'status-danger';
            } finally {
                // Re-enable buttons after 2 seconds
                setTimeout(() => {
                    buttons.forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    });
                }, 2000);
            }
        }

        // Energy Rules Management
        async function updateRule(ruleType) {
            try {
                const rules = {
                    boiler_priority: {
                        enabled: false
                    }
                };

                const res = await fetch('/api/energy_rules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(rules)
                });
                
                const result = await res.json();
                if (result.success) {
                    // Removed currentRule element
                    // Removed currentRule element
                } else {
                    console.error('Failed to update rules:', result.error);
                }
            } catch (e) {
                console.error('Error updating rules:', e);
            }
        }

        function updateWorkModeButtons(currentMode) {
            const modeMap = {0: 'Manual', 1: 'Anti-Feed', 2: 'Trade Mode'};
            
            // Update current mode display
            const currentModeEl = document.getElementById('current-work-mode');
            if (currentModeEl && currentMode !== null && currentMode !== undefined) {
                currentModeEl.textContent = modeMap[currentMode] || `Mode ${currentMode}`;
            }
            
            // Update button styles
            for (let i = 0; i <= 2; i++) {
                const btn = document.getElementById(`work-mode-${i}`);
                if (btn) {
                    if (i === currentMode) {
                        // Active button: green, pressed, disabled
                        btn.className = 'btn btn-success';
                        btn.style.opacity = '0.8';
                        btn.style.transform = 'scale(0.95)';
                        btn.disabled = true;
                    } else {
                        // Inactive button: normal blue, clickable
                        btn.className = 'btn btn-primary';
                        btn.style.opacity = '1';
                        btn.style.transform = 'scale(1)';
                        btn.disabled = false;
                    }
                }
            }
        }

        async function setMinimumSoc() {
            const el = document.getElementById('battery78-control-msg');
            const socButtons = document.querySelectorAll('[onclick*="MinimumSoc"], [onclick*="resetToFactory"]');
            
            try {
                // Disable SoC buttons and show loading
                socButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.6';
                });
                el.textContent = `‚è≥ Minimum SoC wordt ingesteld...`;
                el.className = 'status-info';
                
                const minSoc = parseFloat(document.getElementById('minSocSlider').value);
                
                const payload = { 
                    min_soc_percent: minSoc, 
                    auto_charge: true  // Always enable auto charge when setting minimum
                };
                
                const res = await fetch('/api/battery/minimum_soc', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const j = await res.json();
                
                if (j.success) {
                    if (j.action_taken === 'emergency_charge') {
                        el.textContent = `‚ö†Ô∏è SoC te laag (${j.current_soc}%) - Noodlading gestart!`;
                        el.className = 'status-warning';
                    } else {
                        el.textContent = `‚úÖ Min SoC: ${minSoc}% ingesteld`;
                        el.className = 'status-good';
                    }
                } else {
                    el.textContent = `Fout: ${j.error || 'onbekend'}`;
                    el.className = 'status-danger';
                }
                setTimeout(refreshData, 1200);
            } catch (e) {
                el.textContent = `‚ùå Fout bij min SoC: ${e}`;
                el.className = 'status-danger';
            } finally {
                // Re-enable SoC buttons after 2 seconds
                setTimeout(() => {
                    socButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    });
                }, 2000);
            }
        }


        async function updateSocProtectionDisplay(batteryData) {
            try {
                // Get current battery config
                const configRes = await fetch('/api/battery/config');
                const configData = await configRes.json();
                
                if (configData.success && batteryData && batteryData.soc_percent) {
                    const currentSoc = batteryData.soc_percent.value;
                    const minSoc = configData.config.minimum_soc_percent;
                    const autoCharge = configData.config.auto_charge_enabled;
                    
                    // Update displays
                    document.getElementById('current-soc-display').textContent = `${currentSoc.toFixed(1)}%`;
                    document.getElementById('active-min-soc').textContent = `${minSoc}%`;
                    
                    // Update slider to match saved config
                    document.getElementById('minSocSlider').value = minSoc;
                    document.getElementById('minSocValue').textContent = `${minSoc}%`;
                    
                    // Update status
                    const statusEl = document.getElementById('soc-protection-status');
                    if (currentSoc <= minSoc) {
                        statusEl.textContent = '‚ö†Ô∏è Te laag - Emergency charge';
                        statusEl.style.color = 'var(--danger-color)';
                    } else if (currentSoc <= minSoc + 2) {
                        statusEl.textContent = '‚ö° Hysteresis zone';
                        statusEl.style.color = 'var(--warning-color)';
                    } else {
                        statusEl.textContent = '‚úÖ Veilig';
                        statusEl.style.color = 'var(--success-color)';
                    }
                }
            } catch (e) {
                console.error('Error updating SoC protection display:', e);
            }
        }

        async function resetToFactory() {
            const el = document.getElementById('battery78-control-msg');
            try {
                // Reset to factory settings: no minimum SoC protection
                const payload = { 
                    min_soc_percent: 15.0,  // Just above hardware limit
                    auto_charge: false      // Disable our protection
                };
                
                // Stop any active force charge first
                const stopRes = await fetch('/api/battery/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'stop' })
                });
                
                // Set factory settings
                const res = await fetch('/api/battery/minimum_soc', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const j = await res.json();
                
                if (j.success) {
                    el.textContent = `üîÑ Reset naar fabrikant - Batterij bepaalt zelf wanneer te stoppen`;
                    el.className = 'status-good';
                    
                    // Update UI
                    document.getElementById('minSocSlider').value = 15;
                    document.getElementById('minSocValue').textContent = '15%';
                } else {
                    el.textContent = `Fout bij reset: ${j.error || 'onbekend'}`;
                    el.className = 'status-danger';
                }
                setTimeout(refreshData, 1200);
            } catch (e) {
                el.textContent = `Fout bij reset naar fabrikant: ${e}`;
                el.className = 'status-danger';
            }
        }

        // --- Main Refresh Logic ---
        function startAutoRefresh() {
            refreshData();
            autoRefreshInterval = setInterval(refreshData, 5000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        }

        async function refreshData() {
            try {
                const ts = Date.now();
                const [statusRes, b1Res, b2Res] = await Promise.all([
                    fetch(`/api/status?ts=${ts}`, { cache: 'no-store' }),
                    fetch(`/api/battery/status?ts=${ts}`, { cache: 'no-store' }),
                    fetch(`/api/batteries/venus_ev2_74/status?ts=${ts}`, { cache: 'no-store' })
                ]);
                const statusData = await statusRes.json();
                const b1Data = await b1Res.json();
                const b2Data = await b2Res.json();

                updateSystemMetrics(statusData);
                updateBattery78(b1Data);
                updateBattery2(b2Data);
            } catch (error) {
                console.error('Error refreshing data:', error);
            }
        }

        // --- UI Update Functions ---
        function updateBattery78(batteryData) {
            if (batteryData.success && batteryData.data) {
                setBatteryStatus('battery78', 'connected');
                const d = batteryData.derived || {};
                const raw = batteryData.data;

                // SoC
                const socEl = document.getElementById('battery78-soc');
                socEl.textContent = d.soc_percent != null ? `${d.soc_percent.toFixed(1)} %` : '--';
                socEl.className = d.soc_percent > 80 ? 'metric-value status-good' : d.soc_percent > 20 ? 'metric-value status-warning' : 'metric-value status-danger';

                // Energy Remaining
                document.getElementById('battery78-energy').textContent = d.remaining_kwh != null ? `${d.remaining_kwh.toFixed(2)} kWh` : '--';

                // Power
                const powerEl = document.getElementById('battery78-power');
                const power_w = d.power_w;
                if (power_w != null) {
                    powerEl.textContent = `${power_w.toFixed(0)} W`;
                    powerEl.className = power_w > 20 ? 'metric-value status-good' : power_w < -20 ? 'metric-value status-danger' : 'metric-value';
                } else {
                    powerEl.textContent = '--';
                }

                // Update work mode buttons
                if (raw && raw.user_work_mode && raw.user_work_mode.value !== null) {
                    updateWorkModeButtons(raw.user_work_mode.value);
                }

                // Update SoC protection display
                updateSocProtectionDisplay(raw);


                // Current Action (from register 35100)
                const actionEl = document.getElementById('battery78-action');
                if (raw && raw.work_mode && raw.work_mode.formatted) {
                    const modeText = raw.work_mode.formatted;
                    actionEl.textContent = modeText;
                    if (modeText === 'Charging') {
                        actionEl.className = 'metric-value status-good';
                    } else if (modeText === 'Discharging') {
                        actionEl.className = 'metric-value status-danger';
                    } else {
                        actionEl.className = 'metric-value';
                    }
                } else {
                    actionEl.textContent = 'Onbekend';
                }

                // Timestamp
                document.getElementById('battery78-timestamp').textContent = new Date().toLocaleTimeString();

                // RS485 control and setpoints (formatted if available)
                const rs = raw.rs485_control_enable;
                const cmd = raw.control_mode_command;
                const spc = raw.charge_setpoint_power;
                const spd = raw.discharge_setpoint_power;
                document.getElementById('battery78-rs485').textContent = rs ? (rs.formatted || rs.value || '--') : '--';
                document.getElementById('battery78-cmd').textContent = cmd ? (cmd.formatted || cmd.value || '--') : '--';
                document.getElementById('battery78-sp-charge').textContent = spc ? (spc.formatted || `${spc.value} W`) : '--';
                document.getElementById('battery78-sp-discharge').textContent = spd ? (spd.formatted || `${spd.value} W`) : '--';

            } else {
                setBatteryStatus('battery78', 'error');
                console.warn('Battery data error:', batteryData.error);
            }
        }

        function setBatteryStatus(batteryId, status) {
            const card = document.getElementById(`${batteryId}-card`);
            const badge = document.getElementById(`${batteryId}-badge`);
            if (!card || !badge) return;
            ['connected', 'error', 'connecting'].forEach(c => { card.classList.remove(c); badge.classList.remove(c); });
            card.classList.add(status);
            badge.classList.add(status);
            badge.textContent = status;
        }

        function updateSystemMetrics(data) {
            // PV Generation
            const pv_w = data.pv_generation_w || 0;
            document.getElementById('pvGeneration').textContent = `${pv_w}W`;
            document.getElementById('pvStatus').textContent = pv_w > 100 ? 'Actief' : 'Laag';

            // Grid Import/Export (positive = import from grid, negative = export to grid)
            const grid_w = data.grid_export_w || 0;
            const gridEl = document.getElementById('gridExport');
            gridEl.textContent = grid_w > 0 ? `${grid_w}W (Import)` : grid_w < 0 ? `${Math.abs(grid_w)}W (Export)` : '0W';
            gridEl.className = `metric-value ${grid_w > 10 ? 'status-warning' : grid_w < -10 ? 'status-good' : ''}`;
            document.getElementById('gridStatus').textContent = grid_w > 100 ? 'Importeren' : grid_w < -100 ? 'Exporteren' : 'Neutraal';

            // House Consumption
            const house_w = data.house_consumption_w || 0;
            document.getElementById('houseConsumption').textContent = `${house_w}W`;
            document.getElementById('houseStatus').textContent = house_w > 1000 ? 'Hoog' : 'Normaal';

            // Eddi Status
            document.getElementById('eddiPower').textContent = `${data.eddi_power_w || 0}W`;
            const temps = data.eddi_temperatures || {};
            document.getElementById('tank1Temp').textContent = temps.tank1 != null ? `${temps.tank1}¬∞C` : 'N/A';
            document.getElementById('tank2Temp').textContent = temps.tank2 != null ? `${temps.tank2}¬∞C` : 'N/A';

            // Zappi Status
            document.getElementById('zappiPower').textContent = `${data.zappi_power_w || 0}W`;
        }

        // --- Initializer ---
        document.addEventListener('DOMContentLoaded', startAutoRefresh);
        document.getElementById('autoRefresh').addEventListener('change', (e) => e.target.checked ? startAutoRefresh() : stopAutoRefresh());
    </script>
</body>
</html>
                
                <!-- Simple Rule Toggle -->
                <div style="background: var(--bg-color); border-radius: 12px; padding: 30px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px;">
                        <span style="font-size: 18px; font-weight: 600;">üî• Eddi krijgt altijd voorrang</span>
                        
                        <!-- Beautiful Toggle Switch -->
                        <label class="toggle-switch">
                            <input type="checkbox" id="eddiPriorityToggle" onchange="toggleRule()" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        
                        <span id="ruleStatus" style="font-size: 16px; font-weight: 600; color: var(--success-color);">AAN</span>
                    </div>
                    
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 25px;">
                        Batterijen laden alleen uit overschot dat Eddi niet nodig heeft
                    </div>
                    
                    <!-- Battery Selection -->
                    <div style="background: var(--card-bg); border-radius: 8px; padding: 20px; border: 1px solid var(--border-color);">
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 15px; color: var(--text-primary);">
                            üîã Batterijen die meedoen:
                        </div>
                        
                        <div style="display: flex; justify-content: center; gap: 30px;">
                            <!-- Battery 1 -->
                            <label class="battery-toggle">
                                <input type="checkbox" id="battery1Toggle" onchange="updateBatteries()" checked>
                                <div class="battery-card">
                                    <div class="battery-icon">üîã</div>
                                    <div class="battery-name">Venus E 78</div>
                                    <div class="battery-status">Actief</div>
                                </div>
                            </label>
                            
                            <!-- Battery 2 -->
                            <label class="battery-toggle">
                                <input type="checkbox" id="battery2Toggle" onchange="updateBatteries()" disabled>
                                <div class="battery-card disabled">
                                    <div class="battery-icon">üîã</div>
                                    <div class="battery-name">WiFi Converter</div>
                                    <div class="battery-status">Niet aangesloten</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Temperature Override for Testing -->
                    <div style="margin-top: 20px; padding: 15px; background: var(--warning-color); color: white; border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 10px;">üå°Ô∏è Tank Temperatuur (Testing):</div>
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                            <label style="min-width: 80px;">Override:</label>
                            <input type="checkbox" id="tempOverrideToggle" onchange="updateTempOverride()" style="margin-right: 10px;">
                            <input type="range" id="tempSlider" min="20" max="80" step="1" value="45" disabled
                                   oninput="document.getElementById('tempValue').textContent=this.value+'¬∞C'" style="flex: 1;">
                            <span id="tempValue" style="min-width: 50px; font-weight: 600;">45¬∞C</span>
                        </div>
                        <div style="font-size: 12px; opacity: 0.9;">Zet override aan om tank temperatuur handmatig in te stellen voor testing</div>
                    </div>
                    
                    <!-- Rule Status -->
                    <div style="margin-top: 20px; padding: 15px; background: var(--info-color); color: white; border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 5px;">üìä Huidige Status:</div>
                        <div id="currentRuleStatus">Regel wordt geladen...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <style>
        /* Beautiful Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--success-color);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* Battery Toggle Cards */
        .battery-toggle {
            cursor: pointer;
        }
        
        .battery-toggle input {
            display: none;
        }
        
        .battery-card {
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            background: var(--bg-color);
            color: var(--text-primary);
            min-width: 120px;
        }
        
        .battery-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,255,255,0.1);
            border-color: var(--info-color);
        }
        
        .battery-toggle input:checked + .battery-card {
            border-color: var(--success-color);
            background: var(--success-color);
            color: white;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
        }
        
        .battery-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .battery-card.disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        .battery-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .battery-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .battery-status {
            font-size: 12px;
            opacity: 0.8;
        }
        </style>

        <script>
        // Simple Rules Management
        async function toggleRule() {
            const toggle = document.getElementById("eddiPriorityToggle");
            const status = document.getElementById("ruleStatus");
            
            const isActive = toggle.checked;
            status.textContent = isActive ? "AAN" : "UIT";
            status.style.color = isActive ? "var(--success-color)" : "var(--text-secondary)";
            
            await updateRuleConfig();
        }
        
        async function updateBatteries() {
            await updateRuleConfig();
        }
        
        // Temperature Override Management
        async function updateTempOverride() {
            const overrideEnabled = document.getElementById("tempOverrideToggle").checked;
            const tempSlider = document.getElementById("tempSlider");
            
            tempSlider.disabled = !overrideEnabled;
            
            if (overrideEnabled) {
                tempSlider.style.opacity = "1";
            } else {
                tempSlider.style.opacity = "0.5";
            }
            
            await updateRuleConfig();
        }
        
        async function updateRuleConfig() {
            try {
                const ruleActive = document.getElementById("eddiPriorityToggle").checked;
                const tempOverride = document.getElementById("tempOverrideToggle").checked;
                const tempValue = document.getElementById("tempSlider").value;
                const battery1 = document.getElementById("battery1Toggle").checked;
                const battery2 = document.getElementById("battery2Toggle").checked;
                
                const config = {
                    "rules": [
                        {
                            "id": "eddi_priority",
                            "name": "üî• Eddi Prioriteit",
                            "description": "Eddi krijgt altijd voorrang, batterijen laden alleen uit restant overschot",
                            "active": ruleActive,
                            "batteries": {
                                "venus_e_78": battery1,
                                "wifi_converter": battery2
                            },
                            "parameters": {
                                "tank_temp_override": tempOverride ? parseFloat(tempValue) : null,
                                "tank_temp_target": 60,
                                "export_threshold_w": 100,
                                "eddi_buffer_w": 200,
                                "max_battery_power_w": 1500,
                                "hysteresis_seconds": 5,
                                "cooldown_seconds": 10
                            }
                        }
                    ],
                    "global_settings": {
                        "check_interval_seconds": 2,
                        "min_soc_failsafe": 15,
                        "last_updated": null
                    }
                };
                
                const response = await fetch("/api/energy_rules", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log("‚úÖ Rules updated successfully");
                    await updateRuleStatus();
                } else {
                    console.error("‚ùå Failed to update rules:", result.error);
                }
                
            } catch (error) {
                console.error("‚ùå Error updating rules:", error);
            }
        }
        
        async function updateRuleStatus() {
            try {
                const response = await fetch("/api/rules/status");
                const result = await response.json();
                
                if (result.success) {
                    const statusEl = document.getElementById("currentRuleStatus");
                    const mode = result.current_mode;
                    const override = result.user_override;
                    const rulesCount = result.active_rules_count;
                    
                    let statusText = "";
                    if (override) {
                        statusText = "üë§ Handmatige controle actief";
                    } else if (rulesCount > 0) {
                        statusText = `ü§ñ ${rulesCount} regel(s) actief - Mode: ${mode}`;
                    } else {
                        statusText = "üîã Batterij controleert zichzelf (Anti-Feed)";
                    }
                    
                    statusEl.textContent = statusText;
                }
            } catch (error) {
                console.error("‚ùå Error getting rule status:", error);
            }
        }
        
        // Load current rules on page load
        async function loadCurrentRules() {
            try {
                const response = await fetch("/api/energy_rules");
                const result = await response.json();
                
                if (result.success && result.data.rules.length > 0) {
                    const rule = result.data.rules[0];
                    
                    // Set toggle states
                    document.getElementById("eddiPriorityToggle").checked = rule.active;
                    document.getElementById("battery1Toggle").checked = rule.batteries.venus_e_78;
                    document.getElementById("battery2Toggle").checked = rule.batteries.wifi_converter;
                    
                    // Update status
                    const status = document.getElementById("ruleStatus");
                    status.textContent = rule.active ? "AAN" : "UIT";
                    status.style.color = rule.active ? "var(--success-color)" : "var(--text-secondary)";
                }
                
                await updateRuleStatus();
            } catch (error) {
                console.error("‚ùå Error loading rules:", error);
            }
        }
        
        // Auto-refresh rule status
        setInterval(updateRuleStatus, 5000);  // Every 5 seconds
        
        // Load rules when page loads
        document.addEventListener("DOMContentLoaded", loadCurrentRules);
        
        </script>



