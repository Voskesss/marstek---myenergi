<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>myenergi ‚Üî Marstek Live Dashboard</title>
    <style>
        :root {
            --bg-color: #0f172a; /* slate-900 */
            --card-bg: #1e293b; /* slate-800 */
            --border-color: #334155; /* slate-700 */
            --text-primary: #f1f5f9; /* slate-100 */
            --text-secondary: #94a3b8; /* slate-400 */
            --text-tertiary: #64748b; /* slate-500 */
            --accent-blue: #3b82f6;
            --status-green: #22c55e;
            --status-yellow: #f59e0b;
            --status-red: #ef4444;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--bg-color);
            color: var(--text-primary);
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: var(--text-primary); }
        .header p { color: var(--text-secondary); }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); }
        .card h3 { margin: 0 0 15px 0; color: var(--text-primary); font-size: 18px; font-weight: 600; }
        .metric { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .metric:last-child { border-bottom: none; }
        .metric-label { font-weight: 500; color: var(--text-secondary); }
        .metric-value { font-weight: 600; font-size: 18px; }
        .status-good { color: var(--status-green); }
        .status-warning { color: var(--status-yellow); }
        .status-danger { color: var(--status-red); }
        .status-info { color: var(--accent-blue); }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-success { background: var(--status-green); color: white; }
        .btn-danger { background: var(--status-red); color: white; }
        .btn-warning { background: var(--status-yellow); color: #1e293b; }
        .btn-secondary { background: var(--border-color); color: var(--text-primary); }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .auto-refresh { text-align: center; margin-bottom: 20px; padding: 10px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color); }
        .battery-card { border: 2px solid var(--border-color); transition: border-color 0.3s; }
        .battery-card.connected { border-color: var(--status-green); }
        .battery-card.error { border-color: var(--status-red); }
        .battery-card.connecting { border-color: var(--status-yellow); }
        .battery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .battery-status-badge { padding: 4px 10px; border-radius: 99px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
        .battery-status-badge.connected { background: var(--status-green); color: var(--bg-color); }
        .battery-status-badge.error { background: var(--status-red); color: white; }
        .battery-status-badge.connecting { background: var(--status-yellow); color: var(--bg-color); }
        .modbus-info { font-size: 12px; color: var(--text-tertiary); margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        input[type=range] { -webkit-appearance: none; appearance: none; width: 100%; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { background: var(--border-color); height: 4px; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: var(--accent-blue); cursor: pointer; margin-top: -7px; }
        pre { white-space:pre-wrap; word-break:break-word; background:#0b1220; padding:12px; border-radius:8px; border:1px solid #1f2937; color: var(--text-secondary); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîã myenergi ‚Üî Marstek Live Dashboard</h1>
            <p>Real-time monitoring en controle van je energie systeem</p>
        </div>
        
        <div class="auto-refresh">
            <label>
                <input type="checkbox" id="autoRefresh" checked> Auto-refresh (5s)
            </label>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="refreshData()">üîÑ Refresh Nu</button>
            <button class="btn btn-warning" onclick="restartApplication()">üîÑ Restart App</button>
            <button class="btn btn-secondary" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
        </div>
        
        <div class="status-grid">
            <!-- MyEnergi Cards -->
            <div class="card">
                <h3>‚òÄÔ∏è PV Generatie</h3>
                <div class="metric"><span class="metric-label">Opwekking</span><span class="metric-value" id="pvGeneration">-</span></div>
                <div class="metric"><span class="metric-label">Status</span><span class="metric-value" id="pvStatus">-</span></div>
            </div>
            <div class="card">
                <h3>‚ö° Grid</h3>
                <div class="metric"><span class="metric-label">Export/Import</span><span class="metric-value" id="gridExport">-</span></div>
                <div class="metric"><span class="metric-label">Status</span><span class="metric-value" id="gridStatus">-</span></div>
            </div>
            <div class="card">
                <h3>üè† Huis Verbruik</h3>
                <div class="metric"><span class="metric-label">Verbruik</span><span class="metric-value" id="houseConsumption">-</span></div>
                <div class="metric"><span class="metric-label">Status</span><span class="metric-value" id="houseStatus">-</span></div>
            </div>
            <div class="card">
                <h3>üî• Eddi (Warmwater)</h3>
                <div class="metric"><span class="metric-label">Vermogen</span><span class="metric-value" id="eddiPower">-</span></div>
                <div class="metric"><span class="metric-label">Tank 1 Temp</span><span class="metric-value" id="tank1Temp">-</span></div>
                <div class="metric"><span class="metric-label">Tank 2 Temp</span><span class="metric-value" id="tank2Temp">-</span></div>
            </div>
            <div class="card">
                <h3>üöó Zappi (Auto)</h3>
                <div class="metric"><span class="metric-label">Vermogen</span><span class="metric-value" id="zappiPower">-</span></div>
            </div>

            <!-- Simplified Battery Card -->
            <div class="card battery-card connecting" id="battery78-card">
                <div class="battery-header">
                    <h3>üîã Venus E Batterij 78</h3>
                    <span class="battery-status-badge connecting" id="battery78-badge">Connecting</span>
                </div>
                <div class="metric"><span class="metric-label">State of Charge</span><span class="metric-value status-info" id="battery78-soc">--</span></div>
                <div class="metric"><span class="metric-label">Energy Remaining</span><span class="metric-value" id="battery78-energy">--</span></div>
                <div class="metric"><span class="metric-label">Battery Power</span><span class="metric-value" id="battery78-power">--</span></div>
                <div class="metric"><span class="metric-label">Hoofdmodus</span><span class="metric-value" id="battery78-work-mode">--</span></div>
                <div class="metric"><span class="metric-label">Huidige Actie</span><span class="metric-value" id="battery78-action">--</span></div>

                <!-- CONTROLS -->
                <div class="metric" style="flex-direction: column; align-items: flex-start; gap:12px; padding-top:15px; border-top: 1px solid var(--border-color); margin-top: 15px;">
                    <span class="metric-label" style="margin-bottom: 8px;">Handmatige Controle</span>
                    <div style="width:100%;">
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom: 10px;">
                            <label style="color:var(--text-secondary);">Power</label>
                            <input id="powerSlider" type="range" min="0" max="2000" step="50" value="500" oninput="document.getElementById('powerValue').textContent=this.value+' W'" />
                            <span id="powerValue" style="min-width:60px; text-align:right; font-weight:600;">500 W</span>
                        </div>
                        <div style="display:flex; flex-wrap:wrap; gap:8px;">
                            <button class="btn btn-success" onclick="batteryControl('charge')">Force Charge</button>
                            <button class="btn btn-danger" onclick="batteryControl('discharge')">Force Discharge</button>
                            <button class="btn btn-secondary" onclick="batteryControl('stop')">Stop Force</button>
                        </div>
                    </div>
                    <div style="width:100%; border-top: 1px solid var(--border-color); margin-top: 15px; padding-top: 15px;">
                         <label style="color:var(--text-secondary); margin-bottom: 10px;">Hoofd Werkmodus</label>
                        <div style="display:flex; flex-wrap:wrap; gap:8px;">
                            <button class="btn btn-primary" onclick="setWorkMode(0)">Auto</button>
                            <button class="btn btn-primary" onclick="setWorkMode(1)">Manual</button>
                            <button class="btn btn-primary" onclick="setWorkMode(2)">Trade</button>
                        </div>
                    </div>
                </div>
                <div class="modbus-info">
                    <span id="battery78-control-msg" style="font-size: 12px;"></span><br>
                    <strong>Last Update:</strong> <span id="battery78-timestamp">--</span>
                </div>
            </div>
        </div>
        
        <!-- System Status -->
        <div class="card">
            <h3>üéõÔ∏è Systeem Status</h3>
            <div class="metric">
                <span class="metric-label">Regellogica</span>
                <span class="metric-value" id="controlLogic">-</span>
            </div>
            <div class="metric">
                <span class="metric-label">Batterij Actie</span>
                <span class="metric-value" id="batteryAction">-</span>
            </div>
            <div class="metric">
                <span class="metric-label">Laatste Update</span>
                <span class="metric-value" id="lastUpdate">-</span>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval;

        // --- API Wrappers ---
        async function setWorkMode(mode) {
            const el = document.getElementById('battery78-control-msg');
            try {
                const res = await fetch('/api/battery/set_work_mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode })
                });
                const j = await res.json();
                if (j.success) {
                    const modeMap = {0: 'Auto', 1: 'Manual', 2: 'Trade Mode'};
                    el.textContent = `OK: Werkmodus ingesteld op ${modeMap[mode]}`;
                    el.className = 'status-good';
                } else {
                    el.textContent = `Fout: ${j.error || 'onbekend'}`;
                    el.className = 'status-danger';
                }
                setTimeout(refreshData, 1200);
            } catch (e) {
                el.textContent = `Fout bij instellen werkmodus: ${e}`;
                el.className = 'status-danger';
            }
        }

        async function batteryControl(action) {
            const el = document.getElementById('battery78-control-msg');
            try {
                const power_w = parseInt(document.getElementById('powerSlider').value, 10);
                const payload = { action, power_w };
                const res = await fetch('/api/battery/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const j = await res.json();
                if (j.success) {
                    el.textContent = `OK: ${j.action} commando verstuurd.`;
                    el.className = 'status-good';
                } else {
                    el.textContent = `Fout: ${j.error || 'onbekend'}`;
                    el.className = 'status-danger';
                }
                setTimeout(refreshData, 1200);
            } catch (e) {
                el.textContent = `Fout bij geforceerde controle: ${e}`;
                el.className = 'status-danger';
            }
        }

        // --- Main Refresh Logic ---
        function startAutoRefresh() {
            refreshData();
            autoRefreshInterval = setInterval(refreshData, 5000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        }

        async function refreshData() {
            try {
                const [statusRes, batteryRes] = await Promise.all([
                    fetch(`/api/status?ts=${Date.now()}`, { cache: 'no-store' }),
                    fetch(`/api/battery/status?ts=${Date.now()}`, { cache: 'no-store' })
                ]);
                const statusData = await statusRes.json();
                const batteryData = await batteryRes.json();

                updateSystemMetrics(statusData);
                updateBattery78(batteryData);

                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error refreshing data:', error);
            }
        }

        // --- UI Update Functions ---
        function updateBattery78(batteryData) {
            if (batteryData.success && batteryData.data) {
                setBatteryStatus('battery78', 'connected');
                const d = batteryData.derived || {};
                const raw = batteryData.data;

                // SoC
                const socEl = document.getElementById('battery78-soc');
                socEl.textContent = d.soc_percent != null ? `${d.soc_percent.toFixed(1)} %` : '--';
                socEl.className = d.soc_percent > 80 ? 'metric-value status-good' : d.soc_percent > 20 ? 'metric-value status-warning' : 'metric-value status-danger';

                // Energy Remaining
                document.getElementById('battery78-energy').textContent = d.remaining_kwh != null ? `${d.remaining_kwh.toFixed(2)} kWh` : '--';

                // Power
                const powerEl = document.getElementById('battery78-power');
                const power_w = d.power_w;
                if (power_w != null) {
                    powerEl.textContent = `${power_w.toFixed(0)} W`;
                    powerEl.className = power_w > 20 ? 'metric-value status-good' : power_w < -20 ? 'metric-value status-danger' : 'metric-value';
                } else {
                    powerEl.textContent = '--';
                }

                // Main Work Mode (from register 42001, if available)
                const workModeEl = document.getElementById('battery78-work-mode');
                const workModeVal = raw.user_work_mode?.value;
                const workModeMap = { 0: 'Auto', 1: 'Manual', 2: 'Trade Mode', 3: 'Backup Mode' };
                workModeEl.textContent = workModeMap[workModeVal] || 'Onbekend';

                // Current Action (from register 35100)
                const actionEl = document.getElementById('battery78-action');
                actionEl.textContent = d.mode || '--';
                actionEl.className = d.mode === 'Charging' ? 'metric-value status-good' : d.mode === 'Discharging' ? 'metric-value status-danger' : 'metric-value';

                // Timestamp
                document.getElementById('battery78-timestamp').textContent = new Date().toLocaleTimeString();

            } else {
                setBatteryStatus('battery78', 'error');
                console.warn('Battery data error:', batteryData.error);
            }
        }

        function setBatteryStatus(batteryId, status) {
            const card = document.getElementById(`${batteryId}-card`);
            const badge = document.getElementById(`${batteryId}-badge`);
            if (!card || !badge) return;
            ['connected', 'error', 'connecting'].forEach(c => { card.classList.remove(c); badge.classList.remove(c); });
            card.classList.add(status);
            badge.classList.add(status);
            badge.textContent = status;
        }

        function updateSystemMetrics(data) {
            // PV Generation
            const pv_w = data.pv_generation_w || 0;
            document.getElementById('pvGeneration').textContent = `${pv_w}W`;
            document.getElementById('pvStatus').textContent = pv_w > 100 ? 'Actief' : 'Laag';

            // Grid Export/Import
            const export_w = data.grid_export_w || 0;
            const gridEl = document.getElementById('gridExport');
            gridEl.textContent = export_w > 0 ? `+${export_w}W (Export)` : `${Math.abs(export_w)}W (Import)`;
            gridEl.className = `metric-value ${export_w > 10 ? 'status-good' : export_w < -10 ? 'status-danger' : ''}`;
            document.getElementById('gridStatus').textContent = export_w > 100 ? 'Exporteren' : export_w < -100 ? 'Importeren' : 'Neutraal';

            // House Consumption
            const house_w = data.house_consumption_w || 0;
            document.getElementById('houseConsumption').textContent = `${house_w}W`;
            document.getElementById('houseStatus').textContent = house_w > 1000 ? 'Hoog' : 'Normaal';

            // Eddi Status
            document.getElementById('eddiPower').textContent = `${data.eddi_power_w || 0}W`;
            const temps = data.eddi_temperatures || {};
            document.getElementById('tank1Temp').textContent = temps.tank1 != null ? `${temps.tank1}¬∞C` : 'N/A';
            document.getElementById('tank2Temp').textContent = temps.tank2 != null ? `${temps.tank2}¬∞C` : 'N/A';

            // Zappi Status
            document.getElementById('zappiPower').textContent = `${data.zappi_power_w || 0}W`;
        }

        // --- Initializer ---
        document.addEventListener('DOMContentLoaded', startAutoRefresh);
        document.getElementById('autoRefresh').addEventListener('change', (e) => e.target.checked ? startAutoRefresh() : stopAutoRefresh());
    </script>
</body>
</html>
